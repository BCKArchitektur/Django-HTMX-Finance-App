{% extends 'tracker/base.html' %}
{% load custom_filters %}
{% block title %}Edit Project{% endblock %}

{% block content %}
<div class="container mx-auto p-4" x-data="{ showForm: false }">
    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-2">
            <!-- Back Arrow Button -->
            <button class="btn btn-circle btn-outline" onclick="window.location.href='{% url 'projects' %}';">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
        </div>
        <div class="join align-middle justify-center items-center">
            <h2 class="text-lg font-thin"></h2>
            <h2 class="text-3xl font-sans font-medium justify-items-start">{{ project.project_name }}</h2>
        </div>
        <div class="flex items-center gap-2">
            <!-- Toggle Button -->
            <button class="btn btn-circle btn-outline" @click="showForm = !showForm">
                <svg xmlns="http://www.w3.org/2000/svg" :class="{ 'rotate-180': showForm }" class="h-5 w-5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
        </div>
    </div>
    

    <div x-show="showForm" class="transition-all duration-300 ease-in-out">
        <form method="post" action="{% url 'edit_project' project.id %}">
            {% csrf_token %}
            <div class="grid grid-cols-3 gap-4">
                <div class="form-control">
                    <input type="text" name="project_name" value="{{ project.project_name }}" placeholder="Projektname" class="input input-bordered m-1" id="id_project_name">
                </div>
                <div class="form-control">
                    <input type="text" name="project_address" value="{{ project.project_address }}" placeholder="Projektadresse" class="input input-bordered m-1" id="id_project_address">
                </div>
                <div class="form-control">
                    <select name="client_name" class="select select-bordered m-1" id="id_client_name">
                        {% for client in clients %}
                            <option value="{{ client.id }}" {% if project.client_name.id == client.id %}selected{% endif %}>{{ client.firm_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-control">
                    <input type="text" name="project_no" value="{{ project.project_no }}" placeholder="Projektnummer" class="input input-bordered m-1" id="id_project_no">
                </div>
                <div class="form-control">
                    <select name="status" class="select select-bordered m-1" id="id_status">
                        {% for choice in form.status.field.choices %}
                            <option value="{{ choice.0 }}" {% if form.status.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-control m-1">
                    <label for="id_user" class="label hidden"></label>
                    {{ form.user }}
                </div>                
            </div>
            <div class="modal-action">
                <button type="submit" class="btn btn-primary btn-sm btn-outline">Speichern</button>
            </div>
        </form>
    </div>

    <div class="divider lg:divider-neutral"></div>

    <div role="tablist" class="tabs tabs-bordered mx-auto">
        <input type="radio" name="my_tabs_1" role="tab" class="tab" aria-label="VertrÃ¤ge" id="contracts-tab" checked="checked" />
        <div role="tabpanel" class="tab-content p-10" id="contracts-content">
          <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-semibold"></h2>
              <div class="join gap-4">
                <input type="text" id="contract-search" placeholder="VertrÃ¤ge suchen..." class="input input-bordered input-sm" onkeyup="filterTable('contract-search', 'contract-table')">
              <button class="btn btn-sm btn-neutral font-mono btn-outline" onclick="openContractModal({{ project.id }})">+ Neuer Vertrag</button>
            </div>  
            </div>
          <div class="animate-table-fade-in h-[55vh] w-[75vw] overflow-x-auto" >
              <table class="table" id="contract-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0, 'contract-table')" data-column="0">
                            Vertrag Nr.
                            <span class="sort-indicator"></span>
                        </th>
                        <th > HOAI
                        </th>
                        <th onclick="sortTable(2, 'contract-table')" data-column="2">
                            Vertrag
                            <span class="sort-indicator"></span>
                        </th>
                        <th>
                            Benutzer
                        </th>
                        <th>
                            Aktionen
                        </th>
                        <th>
                            
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for contract in contracts %}
                    <tr class="hover:bg-base-300">
                        <td class="w-1/6">
                            <a href="javascript:void(0);" onclick="openEditContractModal({{ contract.id }})" class="font-semibold hover:text-secondary">
                                {{ contract.contract_no}}
                            </a>
                          
                        </td>
                        <!-- if contrract is hoai show it as status  -->
                        <td class="w-1/8">
                            {% if contract.hoai_data %}
                                <span class="badge badge-success badge-outline">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                                    </svg>
                                </span>
                            {% else %}
                                <span class="badge badge-error badge-outline">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </span>
                            {% endif %}
                        </td>
                        
                        <td class="w-1/4">
                            <a href="javascript:void(0);" onclick="openEditContractModal({{ contract.id }})" class="font-semibold hover:text-secondary">
                                {{ contract.contract_name }}
                            </a>
                        </td>
                        <td class="w-1/2">
                            <div class="max-h-36 overflow-y-auto">
                                {% for section in contract.section.all %}
                                <strong>{{ section.section_name }}</strong><br>
                                {% for item in section.Item.all %}
                                    {{ item.Item_name }}:
                                    <div class="flex flex-wrap gap-1">
                                        {% for user in item.users.all %}
                                        <div class="avatar placeholder">
                                            <div class="bg-gray-300 m-0.2 text-gray-700 rounded-full w-7 h-7 flex items-center justify-center text-xs">
                                            {{ user.username|slice:":2"|upper }}
                                            </div>
                                        </div>     
                                        {% endfor %}
                                    </div>                                    
                                    <br>
                                {% endfor %}
                                {% endfor %}
                            </div>                            
                        </td>
                        <td class="w-1/2">
                            <div class="flex flex-col items-center justify-center h-full gap-1 py-2">
                                <button class="btn btn-xs btn-primary btn-outline h-10 w-24" onclick="openAddUsersModal({{ contract.id }})">
                                    âœŽ Benutzer
                                </button>
                                <button class="btn btn-xs btn-primary btn-outline h-10 w-24" onclick="openAddBudgetModal({{ contract.id }})">
                                    âœŽ Budget
                                </button>
                                <button class="btn btn-xs btn-primary btn-outline h-10 w-24" onclick="openScopeModal({{ contract.id }})">
                                    âœŽ Scope 
                                </button>
                                <button class="btn btn-xs btn-secondary btn-outline h-10 w-24" onclick="openTemplateModal({{ contract.id }})">
                                    ðŸ–ª Angebot
                                </button>
                            </div>
                        </td>
                        
                            <td class="w-1/12">
                                <form method="post" action="{% url 'delete_contract' contract.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-circle btn-error btn-outline p-1 m-1" onclick="return confirm('Are you sure you want to delete this contract?');">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </form>
                            </td>                        
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">Es sind noch keine VertrÃ¤ge hinzugefÃ¼gt worden.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                            
              </table>
          </div>
        </div>
      
        <input type="radio" name="my_tabs_1" role="tab" class="tab" aria-label="Rechnungen" id="invoices-tab" />
        <div role="tabpanel" class="tab-content p-10" id="invoices-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold"></h2>
                <div class="join gap-4">
                    <input type="text" id="invoice-search" placeholder="Rechnungen suchen..." class="input input-bordered input-sm" onkeyup="filterTable('invoice-search', 'invoice-table')">
                    <button class="btn btn-sm btn-neutral font-mono btn-outline" onclick="openInvoiceModal()">+ Neue Rechnung</button>
                </div>
            </div>
            <div class="animate-table-fade-in h-[55vh] w-[75vw] overflow-x-auto" >
                <table class="table" id="invoice-table">
                    <thead>
                        <tr class="hover:bg-base-300">
                            <th onclick="sortTable(0, 'invoice-table')" data-column="0">
                                Rechnungs Nr.
                                <span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable(1, 'invoice-table')" data-column="1">
                                Typ
                                <span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable(2, 'invoice-table')" data-column="2">
                                Vertrag
                                <span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable(3, 'invoice-table')" data-column="3">
                                Ausgabedatum
                                <span class="sort-indicator"></span>
                            </th>


                            <th onclick="sortTable(4, 'invoice-table')" data-column="5">
                                Netto (â‚¬)
                                <span class="sort-indicator"></span>
                            </th>


                            <th onclick="sortTable(5, 'invoice-table')" data-column="6">
                                Brutto (â‚¬)
                                <span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable(6, 'invoice-table')" data-column="4">
                                Netto (â‚¬) <br> (Aktuell)
                                <span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable(7, 'invoice-table')" data-column="4">
                                Brutto (â‚¬) <br> (Aktuell)
                                <span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable(8, 'invoice-table')" data-column="7">
                                Erhaltener<br>Betrag (â‚¬)
                                <span class="sort-indicator"></span>
                            </th>
                            <th >
                                Aktionen
                            </th>
                            <th >
                            </th>
                        </tr>
                    </thead>
                    
                    <tbody>
                        {% for invoice in invoices %}
                        <tr class="hover:bg-base-300">

                            <td>
                                <a href="javascript:void(0);" onclick="viewInvoice({{ invoice.id }})" class="font-semibold hover:text-secondary">
                                    {{ invoice.title }}
                                </a> 
                            </td>
                            <td>{{ invoice.invoice_type  }}    </td>
                            <td>{{ invoice.contract.contract_name }}</td>
                            <td>{{ invoice.formatted_created_at   }}</td>

                            <td data-value="{{ invoice.invoice_net }}">{{ invoice.invoice_net|german_number }}</td>
                            <td data-value="{{ invoice.invoice_gross }}">{{ invoice.invoice_gross |german_number}}</td>
                            <td data-value="{{ invoice.current_invoice_net }}">{{ invoice.current_invoice_net|german_number }}</td>
                            <td data-value="{{ invoice.current_invoice_gross }}">{{ invoice.current_invoice_gross|german_number }}</td>

                            <td  class="w-1/12" data-value="{{ invoice.amount_received }}">
                                {{ invoice.amount_received|german_number }}
                                {% if invoice.date_of_payment %}
                                    <br><span class="text-xs text-gray-500">({{ invoice.formatted_date_of_payment }})</span>
                                {% endif %}
                            </td>                            
                            <td class="w-1/12">

                                <button class="btn btn-xs btn-primary btn-outline m-1  h-10 w-24" onclick="openRecordPaymentModal({{ invoice.id }})">Payment</button> <!-- New Button -->
                                <a href="javascript:void(0);" onclick="openInvoiceTemplateModal({{ invoice.id }})" class="btn btn-xs btn-secondary btn-outline m-1 p-1  h-10 w-24">ðŸ–ª Invoice</a>
                            
                            </td>
                            <td class="w-1/40" >
                                <form method="post" action="{% url 'delete_invoice' invoice.id %}" style="display:inline;" onsubmit="return confirmDelete();">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-circle btn-error btn-outline m-1 p-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">Es wurden noch keine Rechnungen hinzugefÃ¼gt.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <input type="radio" name="my_tabs_1" role="tab" class="tab" aria-label="Einstellungen" id="settings-tab" />
        <div role="tabpanel" class="tab-content p-10" id="settings-content">
            <h2 class="text-xl font-semibold mb-4"> </h2>

            <div class="alert alert-info mb-6"  id="settings-note">
              <span class="font-semibold"></span> Die hier eingegebenen Werte setzen die StandardstundensÃ¤tze auÃŸer Kraft. Lassen Sie die Felder leer, um die StandardstundensÃ¤tze zu verwenden.
            </div>
            
            <form id="project-settings-form" method="post" action="{% url 'update_project_settings' project.id %}">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="label font-thin">GeschÃ¤ftsfÃ¼hrung</label>
                        <input type="number" step="0.01" name="executive_management_rate"
                               class="input input-bordered w-full required-field font-extralight"
                               placeholder="Standard: 250.00"
                               value="{{ project.hourly_rates_override.executive_management_rate|default_if_none:'' }}" required>
                    </div>
        
                    <div>
                        <label class="label font-thin">Fachplaner/in</label>
                        <input type="number" step="0.01" name="specialist_planner_rate"
                               class="input input-bordered w-full required-field font-extralight"
                               placeholder="Standard: 185.00"
                               value="{{ project.hourly_rates_override.specialist_planner_rate|default_if_none:'' }}" required>
                    </div>
        
                    <div>
                        <label class="label font-thin">Projektleitung</label>
                        <input type="number" step="0.01" name="project_management_rate"
                               class="input input-bordered w-full required-field font-extralight"
                               placeholder="Standard: 165.00"
                               value="{{ project.hourly_rates_override.project_management_rate|default_if_none:'' }}" required>
                    </div>
        
                    <div>
                        <label class="label font-thin">BauÃ¼berwachung</label>
                        <input type="number" step="0.01" name="construction_supervision_rate"
                               class="input input-bordered w-full required-field font-extralight"
                               placeholder="Standard: 155.00"
                               value="{{ project.hourly_rates_override.construction_supervision_rate|default_if_none:'' }}" required>
                    </div>
        
                    <div>
                        <label class="label font-thin">Computational Architect</label>
                        <input type="number" step="0.01" name="computational_architect_rate"
                               class="input input-bordered w-full required-field font-extralight"
                               placeholder="Standard: 155.00"
                               value="{{ project.hourly_rates_override.computational_architect_rate|default_if_none:'' }}" required>
                    </div>
        
                    <div>
                        <label class="label font-thin">Architekt/in</label>
                        <input type="number" step="0.01" name="architect_rate"
                               class="input input-bordered w-full required-field font-extralight"
                               placeholder="Standard: 145.00"
                               value="{{ project.hourly_rates_override.architect_rate|default_if_none:'' }}">
                    </div>
        
                    <div>
                        <label class="label font-thin">Bautechniker/in</label>
                        <input type="number" step="0.01" name="construction_technician_rate"
                               class="input input-bordered w-full required-field font-extralight"
                               placeholder="Standard: 135.00"
                               value="{{ project.hourly_rates_override.construction_technician_rate|default_if_none:'' }}" required>
                    </div>
        
                    <div>
                        <label class="label font-thin">Zeichner/in</label>
                        <input type="number" step="0.01" name="draftsman_rate"
                               class="input input-bordered w-full required-field font-extralight"
                               placeholder="Standard: 115.00"
                               value="{{ project.hourly_rates_override.draftsman_rate|default_if_none:'' }}" required>
                    </div>
                </div>
        
                <div class="flex flex-wrap gap-4 mt-6">
                    <button id="save-settings-button" type="submit" class="btn btn-primary btn-outline">Save</button>
                </div>
    
            </form>
            <div class="flex gap-4 mt-3">

                <form method="post" action="{% url 'reset_project_hourly_rates' project.id %}" 
                      onsubmit="return confirm('Are you sure you want to reset all custom hourly rates?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-error btn-outline">Reset</button>
                </form>
            </div>
            
    </div>

<!-- Add/Edit Users Modal -->
<div id="addUsersModal" class="modal">
    <div class="modal-box max-w-5xl">
        <button class="btn btn-sm btn-circle btn-ghost position:absolute; top-0; right-0; " onclick="closeAddUsersModal()">âœ•</button>

        <h3 class="font-bold text-lg m-4">Add/Edit Users</h3>
        <form id="add-users-form" method="post" action="{% url 'add_users' %}">
            {% csrf_token %}
            <input type="hidden" name="contract_id" id="add_users_contract_id">
            <div class="overflow-x-auto">
                <table class="table" id="users-table">
                    <thead>
                        <tr>
                            <th>NO.</th>
                            <th>SECTION</th>
                            <th>ITEM</th>
                            <!-- Usernames will be populated here by JavaScript -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sections and items will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Save</button>
                <a href="#" class="btn" onclick="closeAddUsersModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Budget Modal -->
<div id="addBudgetModal" class="modal">
    <div class="modal-box max-w-5xl">
        <button class="btn btn-sm btn-circle btn-ghost position:absolute; top-0; right-0; " onclick="closeAddBudgetModal()">âœ•</button>

        <h3 class="font-bold text-lg m-4">Add/Edit Budget</h3>
        <form id="add-budget-form" method="post" action="{% url 'add_budget' %}">
            {% csrf_token %}
            <input type="hidden" name="contract_id" id="add_budget_contract_id">
            <div class="overflow-x-auto">
                <table class="table" id="budget-table">
                    <thead>
                        <tr>
                            <th>NO.</th>
                            <th>SECTION</th>
                            <th>ITEM</th>
                            <th>QUANTITY</th>
                            <th>UNIT</th>
                            <th>RATE</th>
                            <th>TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sections and items will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="overflow-x-auto mt-4">
                <table class="table w-full">
                    <tbody>
                        <tr>
                            <td class="text-right font-thin w-1/6">Sum of Items (â‚¬)</td>
                            <td><input type="text" id="sum_of_items" class="input  input-sm w-1/4" readonly></td>
                        </tr>
                        <tr>
                            <td class="text-right font-thin w-1/6">Additional Fee (%)*</td>
                            <td><input type="number" step="0.01" name="additional_fee_percentage" id="additional_fee_percentage" class="input input-bordered input-secondary input-sm w-1/4"></td>
                        </tr>
                        <tr>
                            <td class="text-right font-thin w-1/6">Additional Fee (â‚¬)</td>
                            <td><input type="text" id="additional_fee" class="input  input-sm w-1/4" readonly></td>
                        </tr>
                        <tr>
                            <td class="text-right font-thin w-1/6">Zuschlag (%)</td>
                            <td>
                                <input type="text" id="zuschlag_value" class="input input-sm w-1/4" readonly>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-right font-thin w-1/6"> - Nachlass (â‚¬) or (%)</td>
                            <td class="flex gap-4 items-center">
                                <!-- Option 1: Fixed value -->
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="nachlass_mode" value="value" id="nachlass_mode_value" class="radio radio-sm" checked>
                                    <input type="number" step="0.01" name="nachlass_value" id="nachlass_value" placeholder="â‚¬"
                                        class="input input-sm w-24" />
                                </label>
                        
                                <!-- Option 2: Percentage -->
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="nachlass_mode" value="percentage" id="nachlass_mode_percentage" class="radio radio-sm">
                                    <input type="number" step="0.00001" name="nachlass_percentage" id="nachlass_percentage" placeholder="%"
                                        class="input input-sm w-24" />
                                </label>
                            </td>
                        </tr>
                        
                        <tr>
                            <td class="text-right font-bold w-1/6">Net Contract (â‚¬)</td>
                            <td><input type="text" id="net_contract" class="input  input-sm w-1/4" readonly></td>
                        </tr>

                        
                        <tr>
                            <td class="text-right font-thin w-1/6">VAT (%)*</td>
                            <td>
                                <!-- Select field for VAT percentage -->
                                <select id="vat_percentage_select" class="select select-bordered select-secondary input-sm w-1/4">
                                    <option value="0.00">0%</option>
                                    <option value="19.00">19%</option>
                                </select>
                            
                                <!-- Hidden input field to store the selected VAT value -->
                                <input type="number" id="id_vat_percentage" name="vat_percentage" class="input input-bordered input-sm hidden" value="19.00">
                            </td>
                        </tr>                     
                        
                        <tr>
                            <td class="text-right font-thin w-1/6">VAT (â‚¬)</td>
                            <td><input type="text" id="vat" class="input  input-sm w-1/4" readonly></td>
                        </tr>
                        <tr>
                            <td class="text-right font-bold w-1/6">Gross Contract (â‚¬)</td>
                            <td><input type="text" id="gross_contract" class="input input-sm w-1/4" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </div>                      
            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Save</button>
                <a href="#" class="btn" onclick="closeAddBudgetModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Scope Modal -->
<div id="scopeModal" class="modal">
    <div class="modal-box max-h-full max-w-6xl">
        <button class="btn btn-sm btn-circle btn-primary btn-ghost position:absolute; top-0; right-0; " onclick="closeScopeModal()">âœ•</button>
        <h4 class="font-bold text-lg">Edit Scope of work</h4>
        <form id="scope-form" method="post" action="{% url 'update_scope' 0 %}">
            {% csrf_token %}
            <input type="hidden" name="contract_id" id="scope_contract_id">
            <div id="quill-editor-container" style="height: 300px;"></div>
            <input type="hidden" name="scope_of_work" id="scope_of_work">
            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Save</button>
                <a href="#" class="btn" onclick="closeScopeModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Modal to select the template -->
<div id="selectTemplateModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Select Template and Valid Until Date</h3>
        <form id="template-form" method="get" action="{% url 'generate_word_document' 0 %}">
            <input type="hidden" name="contract_id" id="template_contract_id">
            
            <div class="form-control m-2">
                <label for="template_name" class="label">Template</label>
                <select name="template_name" id="template_name" class="select select-bordered w-full">
                    <option value="" disabled selected>Select a Template</option>
                    <option value="KOST_De.docx">KOST_De</option>
                    <option value="KOST_En.docx">KOST_En</option>
                    <option value="BCK_De.docx">BCK_De</option>
                    <option value="BCK_En.docx">BCK_En</option>
                </select>
            </div>

            <div class="form-control m-2">
                <label for="valid_until" class="label">Valid Until</label>
                <input type="date" name="valid_until" id="valid_until" class="input input-bordered w-full">
            </div>

            <!-- Terms and Conditions -->
            <div class="form-control m-2">
                <label for="terms_conditions" class="label">Terms & Conditions</label>
                <select name="terms_conditions" id="terms_conditions" class="select select-bordered w-full">
                    <option value="" disabled selected>Select Terms & Conditions</option>
                    <option value="None">None</option>
                    <option value="Studioprojekte">Studioprojekte</option>
                    <option value="Architekturprojekte">Architekturprojekte</option>
                </select>
            </div>

            <!-- Include Scope of Work -->
            <div class="form-control m-2">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="include_scope_of_work" id="include_scope_of_work" class="checkbox checkbox-bordered">
                    <span>Include 'Scope of Work'</span>
                </label>
            </div>
            


            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Download</button>
                <a href="#" class="btn" onclick="closeTemplateModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Modal to select the invoice template and date range -->
<div id="selectInvoiceTemplateModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Select Invoice Template and Date Range</h3>
        <form id="invoice-template-form" method="get" action="{% url 'download_invoice' 0 %}">
            <input type="hidden" name="invoice_id" id="invoice_id">
            
            <!-- Invoice Template Selection -->
            <div class="form-control m-2">
                <label for="invoice_template_name" class="label">Template</label>
                <select name="invoice_template_name" id="invoice_template_name" class="select select-bordered w-full">
                    <option value="inv_BCK_De.docx">BCK De</option>
                    <option value="inv_BCK_En.docx">BCK En</option>
                    <option value="inv_Kost_De.docx">Kost De</option>
                    <option value="inv_Kost_En.docx">Kost En</option>
                </select>
            </div>

            <div class="divider"></div>

            <!-- Performance Period Subheading -->
            <h4 class="font-semibold text-md m-2">Performance Period</h4>

            <!-- From Date -->
            <div class="form-control m-2" >
                <label for="from_date" class="label">From Date</label>
                <input type="date" name="from_date" id="from_date" class="input input-bordered w-full">
            </div>

            <!-- To Date -->
            <div class="form-control m-2">
                <label for="to_date" class="label">To Date</label>
                <input type="date" name="to_date" id="to_date" class="input input-bordered w-full">
            </div>

            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Download</button>
                <a href="#" class="btn" onclick="closeInvoiceTemplateModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

{% include 'tracker/view_invoice_modal.html' %}
{% include 'tracker/record_payment_modal.html' %}
{% include 'tracker/create_invoice.html' %}
{% include 'tracker/contract_form_modal.html' %}
{% include 'tracker/hoai_contract_modal.html' %}

{% endblock %}

{% block extra_scripts %}
<script src="//unpkg.com/alpinejs" defer></script>
<script>
    function showTab(tabName) {
        const tabs = ['contracts', 'invoices', 'settings'];

        tabs.forEach(function(name) {
            // Hide all tab contents
            document.getElementById(`${name}-content`).style.display = 'none';
            // Uncheck all tabs
            document.getElementById(`${name}-tab`).checked = false;
        });

        // Show selected tab content
        document.getElementById(`${tabName}-content`).style.display = 'block';
        // Check selected tab
        document.getElementById(`${tabName}-tab`).checked = true;

        // Update URL
        history.pushState(null, '', window.location.pathname + `?tab=${tabName}`);
    }

    document.getElementById('contracts-tab').addEventListener('click', function () {
        showTab('contracts');
    });
    document.getElementById('invoices-tab').addEventListener('click', function () {
        showTab('invoices');
    });
    document.getElementById('settings-tab').addEventListener('click', function () {
        showTab('settings');
    });

    function initializeTab() {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');

        if (['contracts', 'invoices', 'settings'].includes(tab)) {
            showTab(tab);
        } else {
            showTab('contracts'); // Default
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        initializeTab();
    });

    function setValidUntilDefault(days = 10) {
    const input = document.getElementById('valid_until');
    if (!input || input.value) return; // donâ€™t overwrite if already set

    // Start from today
    const today = new Date();
    today.setDate(today.getDate() + days);

    // Format yyyy-mm-dd
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    input.value = `${yyyy}-${mm}-${dd}`;
    }


    // When opening the template modal
    function openTemplateModal(contractId) {
    document.getElementById('template_contract_id').value = contractId;

    fetch(`/ajax/get-scope/${contractId}/`)
        .then(response => {
        if (!response.ok) throw new Error('Failed to load scope');
        return response.json();
        })
        .then(data => {
        const checkbox = document.getElementById("include_scope_of_work");
        const scopeContent = data.scope || '';
        if (!scopeContent.trim() || scopeContent.trim().toLowerCase() === "none") {
            checkbox.disabled = true;
            checkbox.checked = false;
        } else {
            checkbox.disabled = false;
        }

        // Open the modal
        document.getElementById('selectTemplateModal').classList.add('modal-open');

        // Autofill valid until field (10 days from today)
        setValidUntilDefault(10);
        })
        .catch(error => {
        console.error('Error fetching scope:', error);
        alert('Could not fetch scope for this contract.');
        });
    }

    // Function to close the template modal
    function closeTemplateModal() {
        document.getElementById('selectTemplateModal').classList.remove('modal-open');
    }

    document.getElementById('template-form').addEventListener('submit', function(event) {
        const contractId = document.getElementById('template_contract_id').value;
        const templateName = document.getElementById('template_name').value;
        const validUntil = document.getElementById('valid_until').value;
        const termsConditions = document.getElementById('terms_conditions').value;

        // Check if the validUntil value is provided
        if (!validUntil) {
            alert('Please provide a valid until date.');
            event.preventDefault();  // Prevent form submission
            return;
        }

        // Check if the termsConditions value is selected
        if (!termsConditions) {
            alert('Please select Terms and Conditions.');
            event.preventDefault();  // Prevent form submission
            return;
        }

        // Set the form action URL
        this.action = `{% url 'generate_word_document' 0 %}`.replace('0', contractId) + 
                    `?template_name=${templateName}&valid_until=${validUntil}&terms_conditions=${termsConditions}`;

        // Close the modal
        closeTemplateModal();
    });

    // Function to open the invoice template modal
    function openInvoiceTemplateModal(invoiceId) {
        document.getElementById('invoice_id').value = invoiceId;
        document.getElementById('selectInvoiceTemplateModal').classList.add('modal-open');
    }

    // Function to close the invoice template modal
    function closeInvoiceTemplateModal() {
        document.getElementById('selectInvoiceTemplateModal').classList.remove('modal-open');
    }

    document.getElementById('invoice-template-form').addEventListener('submit', function(event) {
        const invoiceId = document.getElementById('invoice_id').value;
        const templateName = document.getElementById('invoice_template_name').value;
        const fromDate = document.getElementById('from_date').value;
        const toDate = document.getElementById('to_date').value;

        // Check if both date fields are provided
        if (!fromDate || !toDate) {
            alert('Please provide both From and To dates.');
            event.preventDefault();  // Prevent form submission
            return;
        }

        // Set the form action URL
        this.action = `{% url 'download_invoice' 0 %}`.replace('0', invoiceId) + `?template_name=${templateName}&from_date=${fromDate}&to_date=${toDate}`;

        // Close the modal
        closeInvoiceTemplateModal();

    });

    function fetchData(url, callback) {
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => callback(data))
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching data: ' + error.message);
            });
    }

    function populateUsersTable(contractId, projectUsers) {
        fetchData(`/ajax/load-contract-data/?contract_id=${contractId}`, data => {
            const usersTable = document.getElementById('users-table');
            const thead = usersTable.querySelector('thead tr');
            const tbody = usersTable.querySelector('tbody');

            thead.innerHTML = '<th>NO.</th><th>SECTION</th><th>ITEM</th>';
            tbody.innerHTML = '';

            projectUsers.forEach(user => {
                const th = document.createElement('th');
                th.innerHTML = `
                    ${user.username}<br>
                    <input type="checkbox" onclick="toggleUserCheckboxes(${user.id}, this)">
                `;
                thead.appendChild(th);
            });

            data.sections.forEach((section, sectionIndex) => {
                section.items.forEach((item, itemIndex) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${sectionIndex + 1},${itemIndex + 1}</td>
                        <td>${section.section_name}</td>
                        <td>${item.Item_name}</td>
                    `;

                    projectUsers.forEach(user => {
                        const td = document.createElement('td');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = `user_item_${user.id}_${item.id}`;
                        checkbox.checked = item.users.includes(user.id);
                        checkbox.classList.add(`user-checkbox-${user.id}`);
                        td.appendChild(checkbox);
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });
            });
        });
    }

    function updateTotal(itemId) {
        const quantityInput = document.querySelector(`input[name="quantity_${itemId}"]`);
        const rateInput = document.querySelector(`input[name="rate_${itemId}"]`);
        const totalField = document.getElementById(`total_${itemId}`);
        const unitSelect = document.querySelector(`select[name="unit_${itemId}"]`);

        // Guard clause to avoid error in invoice modal
        if (!quantityInput || !rateInput || !unitSelect || !totalField) {
            // If one of the expected fields is missing, assume this is not a budget context
            return;
        }

        const quantityValue = parseGermanNumber(quantityInput.value) || 0;
        const rateValue = parseGermanNumber(rateInput.value) || 0;

        let totalValue;

        if (unitSelect.value === "%") {
            totalValue = (quantityValue / 100) * rateValue;
        } else {
            totalValue = quantityValue * rateValue;
        }

        totalField.textContent = formatNumberToGerman(totalValue);

        updateSummaryFields();
    }

    function updateTotalBudget(itemId) {
        console.log('Updating total budget for item:', itemId);
        const quantityInput = document.querySelector(`input[name="quantity_${itemId}"]`);
        const rateInput = document.querySelector(`input[name="rate_${itemId}"]`);
        const unitSelect = document.querySelector(`select[name="unit_${itemId}"]`);
        const totalField = document.getElementById(`total_${itemId}`);

        if (!quantityInput || !rateInput || !unitSelect || !totalField) return;

        const quantityValue = parseGermanNumber(quantityInput.value) || 0;
        const rateValue = parseGermanNumber(rateInput.value) || 0;

        let totalValue = unitSelect.value === "%" 
            ? (quantityValue / 100) * rateValue 
            : quantityValue * rateValue;

        totalField.textContent = formatNumberToGerman(totalValue);

        updateSummaryFields(); // or whatever budget summary method
    }

    function updateTotalInvoice(itemId) {
        console.log('Updating total invoice for item:', itemId);
        const quantityInput = document.querySelector(`input[name="quantity_${itemId}"]`);
        const totalField = document.getElementById(`total_${itemId}`);

        if (!quantityInput || !totalField) return;

        const quantityValue = parseGermanNumber(quantityInput.value) || 0;
        const rate = parseFloat(quantityInput.dataset.itemRate) || 0;
        const unit = quantityInput.dataset.itemUnit;

        let totalValue = unit === "%" 
            ? (quantityValue / 100) * rate 
            : quantityValue * rate;

        totalField.textContent = totalValue.toFixed(2);

        calculateInvoiceNet(); // or your invoice-specific method
    }


    function calculateInvoiceNet() {
        console.log('Calculating invoice net...');
        let sumOfItems = 0;
        let nachlassApplicableSum = 0;

        document.querySelectorAll('input[name^="quantity_"]').forEach(input => {
            const itemId = input.dataset.itemId;
            const row = input.closest('tr');

            if (!itemId || !row) return;

            const totalField = document.getElementById(`total_${itemId}`);
            const checkbox = row.querySelector(`input[name="select_${itemId}"]`);

            if (!checkbox || !checkbox.checked) {
                if (totalField) totalField.textContent = '0.00';
                return;
            }

            const quantity = parseFloat(input.value.replace(',', '.')) || 0;
            const rate = parseFloat(input.dataset.itemRate) || 0;
            const unit = input.dataset.itemUnit;
            let total = 0;

            if (unit === "%") {
                total = (quantity / 100) * rate;
            } else {
                total = quantity * rate;
            }

            sumOfItems += total;

            const sectionMeta = row?.closest('tbody')?.querySelectorAll('.section-metadata');
            let excludeNachlass = false;
            sectionMeta?.forEach(meta => {
                const sectionIndex = meta.closest('tr').rowIndex;
                const rowIndex = row.rowIndex;
                if (sectionIndex < rowIndex) {
                    excludeNachlass = meta.dataset.excludeNachlass === "true";
                }
            });


            if (!excludeNachlass) {
                nachlassApplicableSum += total;
            }

            if (totalField) {
                totalField.textContent = total.toFixed(2);
            }
        });

        document.getElementById('id_sum_of_items').value = sumOfItems.toFixed(2);

        const additionalFeePercentage = parseFloat(document.getElementById('id_additional_fee_percentage').value) || 0;
        const vatPercentage = parseFloat(document.getElementById('vat_percentage').value) || 0;
        const additionalFee = (sumOfItems * additionalFeePercentage) / 100;

        const nachlassPercentage = parseFloat(document.getElementById('id_nachlass_percentage')?.value) || 0;
        const nachlass = (nachlassApplicableSum * nachlassPercentage) / 100;

        const nachlassValueInput = document.getElementById('id_nachlass_value');
        if (nachlassValueInput) {
            nachlassValueInput.value = nachlass.toFixed(2);
        }

        const invoiceNet = sumOfItems + additionalFee - nachlass;
        const vat = (invoiceNet * vatPercentage) / 100;
        const grossInvoice = invoiceNet + vat;

        document.getElementById('id_additional_fee').value = additionalFee.toFixed(2);
        document.getElementById('id_invoice_net').value = invoiceNet.toFixed(2);
        document.getElementById('id_vat').value = vat.toFixed(2);
        document.getElementById('id_gross_invoice').value = grossInvoice.toFixed(2);
    }



    // Helper function to parse German-style number inputs
    function parseGermanNumber(numberString) {
        // Convert German formatted number (e.g., "1.234,56") to standard float (e.g., 1234.56)
        return parseFloat(numberString.replace(/\./g, '').replace(',', '.'));
    }

    // Format the number into German format (e.g., "1.234,56")
    function formatNumberToGerman(number) {
        // Ensure the number is a valid float
        const parsedNumber = parseFloat(number);

        if (isNaN(parsedNumber)) return '0,00';  // return a default value if the number is invalid

        // Convert the number to German format (e.g., '1.234,00')
        return parsedNumber
            .toFixed(2) // Ensure 2 decimal places
            .replace('.', ',') // Replace the decimal point with a comma
            .replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // Add dots as thousand separators
    }

    function highlightSelectedNachlassInput() {
        const valueInput = document.getElementById('nachlass_value');
        const percentInput = document.getElementById('nachlass_percentage');
        const selectedMode = document.querySelector('input[name="nachlass_mode"]:checked').value;

        if (selectedMode === 'value') {
            valueInput.classList.add('input-secondary');
            percentInput.classList.remove('input-secondary');
        } else {
            percentInput.classList.add('input-secondary');
            valueInput.classList.remove('input-secondary');
        }
    }

    document.querySelectorAll('input[name="nachlass_mode"]').forEach(radio => {
        radio.addEventListener('change', () => {
            highlightSelectedNachlassInput();
            updateSummaryFields();
        });
    });

    document.addEventListener('change', function (event) {
        if (event.target.classList.contains('exclude-nachlass-checkbox')) {
            updateSummaryFields();
        }
    });


    function updateSummaryFields() {
        console.log('Updating summary fields...');

        const itemTotals = document.querySelectorAll('[id^="total_"]');
        let sumOfItems = 0;
        let nachlassApplicableSum = 0;
        
        itemTotals.forEach(totalField => {
            const row = totalField.closest('tr');
            const sectionContainer = row.closest('.section-container');
            const checkbox = sectionContainer.querySelector('.exclude-nachlass-checkbox');

            const itemTotal = parseGermanNumber(totalField.textContent) || 0;

            // Always add to full sum
            sumOfItems += itemTotal;

            // Add to nachlass sum only if not excluded
            if (!checkbox || !checkbox.checked) {
                nachlassApplicableSum += itemTotal;
            }
        });

        console.log('Sum of items:', sumOfItems);

        const additionalFeePercentageInput = document.getElementById('additional_fee_percentage');
        const additionalFeePercentage = parseFloat(additionalFeePercentageInput.value) || 0;
        const additionalFee = (sumOfItems * additionalFeePercentage) / 100;

        console.log('Additional Fee Percentage:', additionalFeePercentage);
        console.log('Additional Fee:', additionalFee);


        const zuschlagPercentage = parseFloat(document.getElementById('zuschlag_value').value) || 0;
        const zuschlagAmount = (sumOfItems * zuschlagPercentage) / 100;


        const nachlassValueInput = document.getElementById('nachlass_value');
        const nachlassPercentageInput = document.getElementById('nachlass_percentage');
        const mode = document.querySelector('input[name="nachlass_mode"]:checked').value;

        let nachlassValue = parseFloat(nachlassValueInput.value.replace(',', '.')) || 0;
        let nachlassPercentage = parseFloat(nachlassPercentageInput.value.replace(',', '.')) || 0;

        // But define `nachlassValue` properly:
        if (mode === 'percentage') {
            nachlassValue = (nachlassApplicableSum * nachlassPercentage) / 100;
            nachlassValueInput.value = nachlassValue.toFixed(2);
        } else if (mode === 'value') {
            nachlassPercentage = (nachlassValue / nachlassApplicableSum) * 100;
            nachlassPercentageInput.value = nachlassPercentage.toFixed(5);
        }

        const netContract = sumOfItems + additionalFee - nachlassValue;

        const vatPercentageInput = document.getElementById('id_vat_percentage');
        const vatPercentage = parseFloat(vatPercentageInput.value) || 0;
        const vat = (netContract * vatPercentage) / 100;

        console.log('Net Contract:', netContract);
        console.log('VAT Percentage:', vatPercentage);
        console.log('VAT:', vat);

        const grossContract = netContract + vat;

        // Apply the custom German number formatting
        document.getElementById('sum_of_items').value = formatNumberToGerman(sumOfItems);
        document.getElementById('additional_fee').value = formatNumberToGerman(additionalFee);
        document.getElementById('net_contract').value = formatNumberToGerman(netContract);
        document.getElementById('vat').value = formatNumberToGerman(vat);
        document.getElementById('gross_contract').value = formatNumberToGerman(grossContract);

        console.log('Gross Contract:', grossContract);
    }

    // Add event listeners to recalculate values when VAT or Additional Fee percentage changes
    document.getElementById('id_vat_percentage').addEventListener('input', updateSummaryFields);
    document.getElementById('additional_fee_percentage').addEventListener('input', updateSummaryFields);
    document.getElementById('nachlass_value').addEventListener('input', updateSummaryFields);
    document.getElementById('nachlass_percentage').addEventListener('input', updateSummaryFields);


    // Function to update the section order input field dynamically
    function updateSectionOrderInput() {
        const sectionContainers = document.querySelectorAll('#budget-table .section-container');
        const sectionOrder = Array.from(sectionContainers).map((container, index) => ({
            id: container.dataset.sectionId, // Assuming section ID is stored in a data attribute
            order: index // The index represents the new order
        }));
        sectionOrderInput.value = JSON.stringify(sectionOrder);
    }

    function moveSectionUp_budget(button) {
        const sectionContainer = button.closest('.section-container');
        const previousSection = sectionContainer.previousElementSibling;

        if (previousSection) {
            sectionContainer.parentNode.insertBefore(sectionContainer, previousSection);
            updateSectionOrderInput();
        }
    }

    function moveSectionDown_budget(button) {
        const sectionContainer = button.closest('.section-container');
        const nextSection = sectionContainer.nextElementSibling;

        if (nextSection) {
            sectionContainer.parentNode.insertBefore(nextSection, sectionContainer);
            updateSectionOrderInput();
        }
    }

    // Function to add hidden input to the form
    function addHiddenInputToForm() {
        let contractJSON = buildContractJSON();
        let jsonInput = document.createElement('input');
        jsonInput.type = 'hidden';
        jsonInput.name = 'contract_json';
        jsonInput.value = JSON.stringify(contractJSON);
        document.getElementById('contract-form').appendChild(jsonInput);
        document.getElementById('contract-form').appendChild(jsonInput);
    }

    function updateContractJSON() {
        // Define a new contract JSON structure
        const newContractJSON = {
            contract_name: document.getElementById('id_contract_name').value,
            sections: []
        };

        // Select all rows from the budget table
        const rows = document.querySelectorAll('#budget-table tbody tr');

        let currentSection = null;

        rows.forEach((row) => {
            const sectionName = row.children[1].querySelector('input').value;
            const itemName = row.children[2].querySelector('input').value;
            const quantity = row.querySelector(`input[name^="quantity"]`).value;
            const unit = row.querySelector(`select[name^="unit"]`).value;
            const rate = row.querySelector(`input[name^="rate"]`).value;

            // If this row starts a new section, push the previous section to the JSON
            if (!currentSection || currentSection.section_name !== sectionName) {
                if (currentSection) {
                    newContractJSON.sections.push(currentSection);
                }

                currentSection = {
                    section_name: sectionName,
                    section_billed_hourly: false, // Set as needed
                    items: []
                };
            }

            // Add the item to the current section
            currentSection.items.push({
                Item_name: itemName,
                quantity: quantity,
                unit: unit,
                rate: rate,
                tasks: [] // Add tasks as needed, or collect from additional fields
            });
        });

        // Push the last section if it exists
        if (currentSection) {
            newContractJSON.sections.push(currentSection);
        }

        console.log("Updated Contract JSON:", JSON.stringify(newContractJSON, null, 2));

        // Update the hidden contract JSON input field if used for submission
        const jsonInput = document.querySelector('input[name="contract_json"]');
        if (jsonInput) {
            jsonInput.value = JSON.stringify(newContractJSON);
        }
    }

    function updateContractJSON_budget() {
        // Define a new contract JSON structure
        const newContractJSON = {
            contract_name: document.getElementById('id_contract_name') ? document.getElementById('id_contract_name').value : '',
            sections: []
        };

        // Select all section containers from the budget table
        const sectionContainers = document.querySelectorAll('#budget-table .section-container');

        // Loop through section containers and assign proper order
        sectionContainers.forEach((sectionContainer, sectionIndex) => {
            const sectionName = sectionContainer.querySelector('.section-name').textContent.trim();

            // Initialize the current section
            const currentSection = {
                id: sectionContainer.dataset.sectionId || null, // Assuming a data attribute for section ID
                order: sectionIndex, // Set the order property based on its current position
                section_name: sectionName,
                section_billed_hourly: false, // Set as needed
                items: []
            };

            // Select all item rows within the current section
            const itemRows = sectionContainer.querySelectorAll('.items-table tbody tr');
            itemRows.forEach((row, itemIndex) => {
                const itemName = row.children[1].querySelector('input').value.trim();
                const quantity = row.querySelector(`input[name^="quantity"]`).value.trim();
                const unit = row.querySelector(`select[name^="unit"]`).value;
                const rate = row.querySelector(`input[name^="rate"]`).value.trim();

                // Add the item to the current section with its updated order
                currentSection.items.push({
                    id: row.dataset.itemId || null, // Assuming a data attribute for item ID
                    order: itemIndex, // Set the order property based on its current position
                    Item_name: itemName,
                    quantity: quantity,
                    unit: unit,
                    rate: rate,
                    tasks: [] // Add tasks as needed, or collect from additional fields
                });
            });

            // Push the current section to the contract JSON
            newContractJSON.sections.push(currentSection);
        });

        console.log("Updated Contract JSON:", newContractJSON);

        // Update the hidden contract JSON input field if used for submission
        const jsonInput = document.querySelector('input[name="contract_json"]');
        if (jsonInput) {
            jsonInput.value = JSON.stringify(newContractJSON);
        }
    }

    function populateBudgetTable(contractId) {
        console.log('Fetching contract data for contract ID:', contractId);

        fetchData(`/ajax/load-contract-data/?contract_id=${contractId}`, data => {
            console.log('Contract data received:', data);

            const budgetTable = document.getElementById('budget-table');
            budgetTable.innerHTML = ''; // Clear existing content

            // Dynamically add or update the hidden input for contract JSON
            const form = document.getElementById('add-budget-form');
            let jsonInput = form.querySelector('input[name="contract_json"]');
            if (!jsonInput) {
                jsonInput = document.createElement('input');
                jsonInput.type = 'hidden';
                jsonInput.name = 'contract_json';
                form.appendChild(jsonInput);
            }

            let isContractInvoiced = false;

            let sectionOrderInput = form.querySelector('input[name="section_order"]');
            if (!window.sectionOrderInput) {
                window.sectionOrderInput = document.createElement('input');
                window.sectionOrderInput.type = 'hidden';
                window.sectionOrderInput.name = 'section_order';
                form.appendChild(window.sectionOrderInput);
            }

            data.sections.forEach((section, sectionIndex) => {
                // Create a container for each section
                const sectionContainer = document.createElement('div');
                sectionContainer.classList.add('section-container', 'my-4', 'p-2', 'border', 'border-gray-300', 'rounded');
                sectionContainer.setAttribute('data-section-index', sectionIndex);

                // Add a header for the section with move buttons
                const sectionHeader = document.createElement('div');
                sectionHeader.classList.add('section-header', 'flex', 'justify-between', 'items-center', 'mb-2');
                sectionHeader.innerHTML = `
                    <div class="section-name font-semibold">${section.section_name}</div>
                    <div>
                        <div class="flex gap-2 items-center">
                            <label class="label cursor-pointer">
                                <span class="label-text text-xs mr-1">Exclude from Nachlass</span>
                                <input type="checkbox" class="checkbox checkbox-sm exclude-nachlass-checkbox" 
                                    data-section-id="${section.id}" ${section.exclude_from_nachlass ? 'checked' : ''}>
                            </label>
                                                    <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionUp_budget(this)">
                            <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" />
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="18" y1="11" x2="12" y2="5" />
                                <line x1="6" y1="11" x2="12" y2="5" />
                            </svg>
                        </button>
                        <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionDown_budget(this)">
                            <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" />
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="18" y1="13" x2="12" y2="19" />
                                <line x1="6" y1="13" x2="12" y2="19" />
                            </svg>
                        </button>
                        </div>
                    </div>
                `;
                sectionContainer.appendChild(sectionHeader);

                // Create a table for the items within this section
                const itemsTable = document.createElement('table');
                itemsTable.classList.add('items-table', 'table', 'w-full');
                itemsTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th class="w-64">Item</th>
                            <th>Hours<br>logged</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Rate</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                // Add items to the itemsTable
                const itemsTableBody = itemsTable.querySelector('tbody');
                section.items.forEach((item, itemIndex) => {
                    const itemInvoiced = item.quantity !== item.available_quantity;
                    if (itemInvoiced) {
                        isContractInvoiced = true;
                    }

                    const unitOptions = `
                        <option value="Std." ${item.unit === 'Std' ? 'selected' : ''}>Std</option>
                        <option value="Psch" ${item.unit === 'Psch' ? 'selected' : ''}>Psch</option>
                        <option value="Stk" ${item.unit === 'Stk' ? 'selected' : ''}>Stk</option>
                        <option value="%" ${item.unit === '%' ? 'selected' : ''}>%</option>
                        <option value="Monat(e)" ${item.unit === 'Monat(e)' ? 'selected' : ''}>Monat(e)</option>
                        <option value="Tag(e)" ${item.unit === 'Tag(e)' ? 'selected' : ''}>Tag(e)</option>
                    `;

                    const isPsch = item.unit === 'Psch';
                    const quantityValue = isPsch ? '1' : (item.quantity || '');
                    const formattedQuantityValue = formatNumberToGerman(quantityValue);
                    const formattedRate = formatNumberToGerman(item.rate || 0);
                    const loggedHours = item.hours_logged || 0;



                    const itemRow = document.createElement('tr');
                    itemRow.innerHTML = `
                        <td>${sectionIndex + 1},${itemIndex + 1}</td>
                        <td class="w-64">${item.Item_name}</td>

                        <td id="hours_logged_${item.id}">${formatNumberToGerman(item.hours_logged || 0)}</td>

                        <td>
                            <input type="text" name="quantity_${item.id}" value="${formattedQuantityValue}" 
                                class="input input-bordered w-full" 
                                ${itemInvoiced ? 'disabled' : (isPsch ? 'readonly' : '')} 
                                onchange="updateTotalBudget(${item.id})">
                            <input type="hidden" name="original_quantity_${item.id}" value="${quantityValue}">
                        </td>
                        <td>
                            <select name="unit_${item.id}" class="select select-bordered w-full" ${itemInvoiced ? 'disabled' : ''} onchange="handleUnitChange(this, ${item.id})">
                                ${unitOptions}
                            </select>
                        </td>
                        <td><input type="text" name="rate_${item.id}" value="${formattedRate}" class="input input-bordered w-full" onchange="updateTotalBudget(${item.id})" ${itemInvoiced ? 'disabled' : ''}></td>
                        <td id="total_${item.id}">${formatNumberToGerman(item.total || 0)}</td>
                    `;

                    itemsTableBody.appendChild(itemRow);

                    // Ensure total updates correctly for percentage-based calculations
                    if (item.unit === '%') {
                        setTimeout(() => updateTotalBudget(item.id), 100);

                    }
                    const quotedQty = item.quantity || 0;
                    const cell = itemRow.querySelector(`#hours_logged_${item.id}`);

                    if (loggedHours > quotedQty) {
                        cell.classList.add("text-red-600"); // Too many hours
                    } else {
                        cell.classList.add("text-green-600"); // Within budget
                    }

                });

                sectionContainer.appendChild(itemsTable); // Append itemsTable to sectionContainer
                budgetTable.appendChild(sectionContainer); // Append sectionContainer to budgetTable
            });

            // Populate additional fee percentage and disable if any item is invoiced
            const additionalFeePercentageInput = document.getElementById('additional_fee_percentage');
            additionalFeePercentageInput.value = data.additional_fee_percentage || 0;
            if (isContractInvoiced) {
                additionalFeePercentageInput.readOnly = true;
                additionalFeePercentageInput.classList.add('border-red-500');
                nachlass_value.readOnly = true;
                nachlass_value.classList.add('border-red-500');
                nachlass_percentage.readOnly = true;
                nachlass_percentage.classList.add('border-red-500');
                nachlass_mode_value.readOnly = true;
            }


            document.getElementById('zuschlag_value').value = data.zuschlag_value || 0; // Fetch Zuschlag
            document.getElementById('nachlass_value').value = data.nachlass_value || 0; 
            document.getElementById('nachlass_percentage').value = data.nachlass_percentage || 0; 

            console.log('nachlass_value', data.nachlass_value )
            // Populate VAT percentage and sync select field with hidden input
            const vatPercentageInput = document.getElementById('id_vat_percentage');
            const vatPercentageSelect = document.getElementById('vat_percentage_select');

            vatPercentageInput.value = data.vat_percentage || 0;
            vatPercentageSelect.value = vatPercentageInput.value; // Sync select input with hidden field

            if (isContractInvoiced) {
                vatPercentageSelect.disabled = true;
            }

            // Initialize the summary fields
            updateSummaryFields();
        });
    }

    function handleUnitChange(selectElement, itemId) {
        const quantityInput = document.querySelector(`input[name="quantity_${itemId}"]`);
        const originalQuantityInput = document.querySelector(`input[name="original_quantity_${itemId}"]`);

        // Reset input properties
        quantityInput.readOnly = false;
        quantityInput.disabled = false;

        switch (selectElement.value) {
            case "Psch":
                quantityInput.value = "1";
                quantityInput.readOnly = true;
                break;

            case "%":
                quantityInput.value = originalQuantityInput.value || "0";
                quantityInput.setAttribute("step", "0.01");
                break;

            case "Monat(e)":
            case "Tag(e)":
                quantityInput.value = originalQuantityInput.value || "1";
                quantityInput.setAttribute("step", "1");
                break;
        }

        updateTotalBudget(itemId);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const vatPercentageSelect = document.getElementById('vat_percentage_select');
        const vatPercentageInput = document.getElementById('id_vat_percentage');

        // Function to sync the select and hidden input field
        function syncVatPercentage() {
            console.log('Syncing VAT percentage...');
            // Update the hidden input value to match the select field value
            vatPercentageInput.value = vatPercentageSelect.value;
            // Log the updated hidden input value
            console.log('Hidden input VAT percentage after sync:', vatPercentageInput.value);

            // Recalculate the summary fields based on the new VAT value
            updateSummaryFields();
        }

        // Initialize the select field based on the current value of the hidden input
        function initializeVatPercentage() {
            console.log('Initializing VAT percentage...');
            if (!vatPercentageInput.value) {
                vatPercentageInput.value = '19.00'; // fallback default
            }
            vatPercentageSelect.value = vatPercentageInput.value;
            console.log('Select field value after initialization:', vatPercentageSelect.value);
        }

        // Ensure the hidden input reflects the select field value upon page load
        initializeVatPercentage();

        // Add event listener to update the hidden input and recalculate when the select value changes
        vatPercentageSelect.addEventListener('change', syncVatPercentage);
    });

    function populateUsersTable(contractId, projectUsers) {
        fetchData(`/ajax/load-contract-data/?contract_id=${contractId}`, data => {
            const usersTable = document.getElementById('users-table');
            const thead = usersTable.querySelector('thead tr');
            const tbody = usersTable.querySelector('tbody');

            thead.innerHTML = '<th>NO.</th><th>SECTION</th><th>ITEM</th>';
            tbody.innerHTML = '';

            projectUsers.forEach(user => {
                const th = document.createElement('th');
                th.innerHTML = `
                    ${user.username}<br>
                    <input type="checkbox" onclick="toggleUserCheckboxes(${user.id}, this)">
                `;
                thead.appendChild(th);
            });

            data.sections.forEach((section, sectionIndex) => {
                section.items.forEach((item, itemIndex) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${sectionIndex + 1},${itemIndex + 1}</td>
                        <td>${section.section_name}</td>
                        <td>${item.Item_name}</td>
                    `;

                    projectUsers.forEach(user => {
                        const td = document.createElement('td');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = `user_item_${user.id}_${item.id}`;
                        checkbox.checked = item.users.includes(user.id);
                        checkbox.classList.add(`user-checkbox-${user.id}`);
                        td.appendChild(checkbox);
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });
            });
        });
    }

    function toggleUserCheckboxes(userId, masterCheckbox) {
        const checkboxes = document.querySelectorAll(`.user-checkbox-${userId}`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = masterCheckbox.checked;
        });
    }

    window.toggleUserCheckboxes = toggleUserCheckboxes;

    function handleFormSubmission(event, form, url) {
        event.preventDefault();

        // Manually append checkbox states
        document.querySelectorAll('.exclude-nachlass-checkbox').forEach((checkbox) => {
            let existingHidden = form.querySelector(`input[name="exclude_section_${checkbox.dataset.sectionId}"]`);

            // Remove if exists
            if (existingHidden) {
                existingHidden.remove();
            }

            let hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = `exclude_section_${checkbox.dataset.sectionId}`;
            hidden.value = checkbox.checked ? 'on' : 'off';
            form.appendChild(hidden);
        });

        const formData = new FormData(form);

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                console.error('Error:', data.error);
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            alert('Error submitting form: ' + error);
        });
    }

    document.getElementById('add-users-form').addEventListener('submit', function(event) {
        handleFormSubmission(event, this, this.action);
    });

    document.getElementById('add-budget-form').addEventListener('submit', function(event) {
        handleFormSubmission(event, this, this.action);
    });

    window.openAddUsersModal = function(contractId) {
        document.getElementById('add_users_contract_id').value = contractId;
        const projectId = {{ project.id }}; // Ensure project.id is correctly passed here
        document.getElementById('addUsersModal').classList.add('modal-open');
        fetch(`/ajax/get-project-users/?project_id=${projectId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    alert('Error: ' + data.error);
                } else {
                    // Populate users table
                    populateUsersTable(contractId, data.project_users);
                }
            })
            .catch(error => {
                console.error('Error fetching project users:', error);
                alert('Error fetching project users: ' + error.message);
            });
    }

    window.closeAddUsersModal = function() {
        document.getElementById('addUsersModal').classList.remove('modal-open');
    }

    window.openAddBudgetModal = function(contractId) {
        document.getElementById('add_budget_contract_id').value = contractId;
        document.getElementById('addBudgetModal').classList.add('modal-open');
        populateBudgetTable(contractId);
    }

    window.closeAddBudgetModal = function() {
        document.getElementById('addBudgetModal').classList.remove('modal-open');
        
        // Clear the budget table
        const budgetTableBody = document.getElementById('budget-table').querySelector('tbody');
        budgetTableBody.innerHTML = '';

        // Reset the summary fields
        document.getElementById('sum_of_items').value = '';
        document.getElementById('additional_fee').value = '';
        document.getElementById('net_contract').value = '';
        document.getElementById('vat').value = '';
        document.getElementById('gross_contract').value = '';
        document.getElementById('nachlass_value').value = '';
        document.getElementById('nachlass_percentage').value = '';



        // Optionally, reset the form itself
        document.getElementById('add-budget-form').reset();
    }

    function confirmDelete() {
            return confirm("Are you sure you want to delete this invoice?");
        }
    


    // document.addEventListener('DOMContentLoaded', () => {
    //     const amountCells = document.querySelectorAll('td[data-value]');
    //     amountCells.forEach(cell => {
    //         const rawValue = cell.getAttribute('data-value');
    //         console.log(rawValue)
    //         const parsedValue = parseGermanNumber_2(rawValue);
    //         console.log(parsedValue)
    //         const formattedValue = formatNumberToGerman(parsedValue);
    //         console.log(formattedValue)
    //         cell.textContent = formattedValue;
    //     });
    // });
</script>

<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>


<script>
    window.quill = null;

    // Initialize Quill editor
    document.addEventListener('DOMContentLoaded', function () {
        highlightSelectedNachlassInput();
        window.quill = new Quill('#quill-editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ list: 'ordered' }, { list: 'bullet' }],
                ],
            },
        });
    });

    // Function to open the Scope Modal
    window.openScopeModal = function (contractId) {
        fetch(`/ajax/get-scope/${contractId}/`)
            .then(response => {
                if (!response.ok) throw new Error('Failed to load scope');
                return response.json();
            })
            .then(data => {
                const scopeContent = data.scope || '';

                const form = document.getElementById('scope-form');
                form.action = `/update-scope/${contractId}/`;
                document.getElementById('scope_contract_id').value = contractId;
                window.quill.root.innerHTML = scopeContent;

                // Optional: Toggle checkbox availability
                const checkbox = document.getElementById("include_scope_of_work");
                if (checkbox) {
                    checkbox.disabled = !scopeContent.trim();
                    checkbox.checked = false;
                }

                document.getElementById('scopeModal').classList.add('modal-open');
            })
            .catch(error => {
                console.error(error);
                alert('Could not load scope content.');
            });
    };




    // Function to close the Scope Modal
    window.closeScopeModal = function () {
        console.log('Closing Scope Modal...');
        document.getElementById('scopeModal').classList.remove('modal-open');
        console.log('Scope Modal closed.');
    };

    // Handle form submission
    document.getElementById('scope-form').addEventListener('submit', function (event) {
        event.preventDefault();
        const form = event.target;

        console.log('Submitting Scope form...');
        const scopeContent = window.quill.root.innerHTML;

        console.log('Form action URL:', form.action);
        console.log('Scope Content:', scopeContent);

        // Set the hidden input value for submission
        document.getElementById('scope_of_work').value = scopeContent;

        // Submit the form via fetch
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
        })
            .then((response) => {
                console.log('Response received:', response);
                if (!response.headers.get('content-type').includes('application/json')) {
                    console.error('Expected JSON response, but received:', response.headers.get('content-type'));
                    throw new Error('Expected JSON response');
                }
                return response.json();
            })
            .then((data) => {
                console.log('Response data:', data);
                if (data.status === 'success') {
                    alert('Scope updated successfully!');
                    console.log('Scope updated successfully. Reloading page...');
                    location.reload();
                } else {
                    alert('Error updating scope: ' + data.message);
                    console.error('Error in response data:', data.message);
                }
            })
            .catch((error) => {
                console.error('Error updating scope:', error);
                alert('An error occurred while updating the scope.');
            });
    });



</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let scopeOfWork = "{{ contract.scope_of_work|escapejs }}".trim();
        let checkbox = document.getElementById("include_scope_of_work");

        if (!scopeOfWork || scopeOfWork.toLowerCase() === "none") {
            checkbox.disabled = true;
        }
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const inputs = document.querySelectorAll('.required-field');
        const saveButton = document.getElementById('save-settings-button');

        function checkCompletion() {
            let allHandled = true;
            inputs.forEach(input => {
                // Consider empty as "use default", so we allow it
                if (input.value !== '' && isNaN(parseFloat(input.value))) {
                    allHandled = false;
                }
            });
            saveButton.disabled = !allHandled;
        }

        inputs.forEach(input => {
            input.addEventListener('input', checkCompletion);
        });

        checkCompletion(); // Initial check
    });
</script>

<script>
        document.addEventListener("DOMContentLoaded", function () {
          new TomSelect("#id_user", {
            plugins: ['remove_button'],
            maxItems: null,
            create: false,
            searchField: 'text',
            placeholder: "Benutzer suchen...",
          });
        });

</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
    
        // If the current tab is settings, or if it gets switched to settings
        function autoHideSettingsNote() {
            const note = document.getElementById("settings-note");
            if (note) {
                setTimeout(() => {
                    note.classList.add("hidden"); // or use note.remove() to fully delete it
                }, 5000); // 5 seconds
            }
        }
    
        // Immediately hide if on load the tab is settings
        if (tab === 'settings') {
            autoHideSettingsNote();
        }
    
        // Also re-check if user clicks the tab manually (optional)
        const settingsTab = document.querySelector('#settings-tab');
        if (settingsTab) {
            settingsTab.addEventListener('click', () => {
                setTimeout(autoHideSettingsNote, 1000); // slight delay to ensure content is visible
            });
        }
    });
    </script>
<script>
    let lastSortedColumn = null;
    let lastSortDirection = 'asc'; // Track the last sort direction (asc/desc)

    function sortTable(columnIndex, tableId) {
        const table = document.getElementById(tableId);
        const rows = Array.from(table.getElementsByTagName('tr')).slice(1); // Get all rows except the header
        const isNumericColumn = rows.every(row => !isNaN(row.cells[columnIndex].innerText.trim()));

        // Determine the sort direction (ascending/descending)
        let sortDirection = 'asc'; // Default to ascending
        if (lastSortedColumn === columnIndex && lastSortDirection === 'asc') {
            sortDirection = 'desc';
        }

        // Sort rows
        rows.sort((rowA, rowB) => {
            const cellA = rowA.cells[columnIndex].innerText.trim();
            const cellB = rowB.cells[columnIndex].innerText.trim();

            if (isNumericColumn) {
                return sortDirection === 'asc' ? parseFloat(cellA) - parseFloat(cellB) : parseFloat(cellB) - parseFloat(cellA);
            } else {
                return sortDirection === 'asc' ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            }
        });

        // Reattach rows in sorted order
        rows.forEach(row => table.appendChild(row));

        // Update sorting indicators
        updateSortIndicators(columnIndex, sortDirection, tableId);

        lastSortedColumn = columnIndex; // Store the last sorted column index
        lastSortDirection = sortDirection; // Store the last sort direction
    }

    function updateSortIndicators(columnIndex, direction, tableId) {
        // Remove indicators from all th elements within the table
        const headers = document.querySelectorAll(`#${tableId} th`);
        headers.forEach(header => {
            const indicator = header.querySelector('.sort-indicator');
            if (indicator) {
                indicator.textContent = ''; // Remove the arrow
            }
        });

        // Add the appropriate indicator to the sorted column
        const sortedHeader = document.querySelector(`#${tableId} th[data-column="${columnIndex}"] .sort-indicator`);
        if (sortedHeader) {
            sortedHeader.textContent = direction === 'asc' ? 'â†‘' : 'â†“'; // Add ascending/descending arrow
        }
    }

    // function toggleProjectStatus() {
    //     const isChecked = document.getElementById("toggleAllProjects").checked;
    //     const table = document.getElementById("project-table");
    //     const rows = table.getElementsByTagName('tr');
        
    //     // Loop through the rows and filter based on the project status
    //     for (let i = 1; i < rows.length; i++) { // Skip header row
    //         const cells = rows[i].getElementsByTagName('td');
    //         const statusCell = cells[2]; // Assuming the status is in the 3rd column
            
    //         if (statusCell) {
    //             const status = statusCell.textContent.trim();
                
    //             if (isChecked) {
    //                 rows[i].style.display = ''; // Show all projects
    //             } else {
    //                 if (status === "Completed" || status === "On Hold") {
    //                     rows[i].style.display = 'none'; // Hide Completed and On Hold projects
    //                 } else {
    //                     rows[i].style.display = ''; // Show only In Progress projects
    //                 }
    //             }
    //         }
    //     }
    // }

    // // Call this function on page load to set the initial visibility
    // document.addEventListener("DOMContentLoaded", function() {
    //     toggleProjectStatus(); // Ensure that only In Progress projects are shown initially
    // });

    function filterTable(inputId, tableId) {
    const input = document.getElementById(inputId);
    const filter = input.value.toLowerCase();
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) { // Skip header row
        const cells = rows[i].getElementsByTagName('td');
        let rowContainsFilter = false;

        for (let j = 0; j < cells.length; j++) {
            if (cells[j]) {
                const cellContent = cells[j].textContent || cells[j].innerText;
                if (cellContent.toLowerCase().indexOf(filter) > -1) {
                    rowContainsFilter = true;
                    break;
                }
            }
        }

        rows[i].style.display = rowContainsFilter ? '' : 'none';
    }
}

    </script>
    <style>
        /* Make text non-selectable */
        th {
            cursor: pointer;
            user-select: none;  /* Prevent text selection */
        }

        /* Add hover effect with smooth transition */
        th:hover {
            background-color: #f0f0f0; /* Light background on hover */
            transition: background-color 0.3s ease; /* Smooth transition for background */
        }

    </style>
    
{% endblock %}
