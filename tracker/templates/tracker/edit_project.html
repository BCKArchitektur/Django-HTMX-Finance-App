{% extends 'tracker/base.html' %}

{% block title %}Edit Project{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <div class="flex justify-between items-center mb-4">
        <div class="join align-middle justify-center items-center">
            <h2 class="text-lg font-thin">Edit - </h2>
            <h2 class="text-2xl font-semibold m-2">{{ project.project_name }}</h2>
        </div>
        <button class="btn btn-circle btn-outline btn-error" onclick="window.location.href='{% url 'projects' %}';">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <form method="post" action="{% url 'edit_project' project.id %}">
        {% csrf_token %}
        <div class="grid grid-cols-3 gap-4">
            <div class="form-control">
                <input type="text" name="project_name" value="{{ project.project_name }}" placeholder="Project Name" class="input input-bordered m-1" id="id_project_name">
            </div>
            <div class="form-control">
                <input type="text" name="project_address" value="{{ project.project_address }}" placeholder="Project Address" class="input input-bordered m-1" id="id_project_address">
            </div>
            <div class="form-control">
                <select name="client_name" class="select select-bordered m-1" id="id_client_name">
                    {% for client in clients %}
                        <option value="{{ client.id }}" {% if project.client_name.id == client.id %}selected{% endif %}>{{ client.client_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-control">
                <input type="text" name="project_no" value="{{ project.project_no }}" placeholder="Project Number" class="input input-bordered m-1" id="id_project_no">
            </div>
            <div class="form-control">
                <select name="status" class="select select-bordered m-1" id="id_status">
                    {% for choice in form.status.field.choices %}
                        <option value="{{ choice.0 }}" {% if form.status.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-control m-1">
                {{ form.user }}
            </div>
        </div>
        <div class="modal-action">
            <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
        </div>
    </form>

    <div class="divider lg:divider-neutral"></div>

    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Manage Contracts</h2>
        <button class="btn btn-sm btn-accent" onclick="openContractModal()">+ New Contract</button>
    </div>
    <div class="overflow-x-auto h-80">
        <table class="table" id="contract-table">
            <thead>
                <tr>
                    <th>Contract Name</th>
                    <th>Users</th>
                    <th>Budget</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for contract in contracts %}
                <tr class="hover">
                    <td>{{ contract.contract_name }}</td>
                    <td>
                        {% for section in contract.section.all %}
                            <strong>{{ section.section_name }}</strong><br>
                            {% for item in section.Item.all %}
                                {{ item.Item_name }}: 
                                {% for user in item.users.all %}
                                    {{ user.username }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                                <br>
                            {% endfor %}
                        {% endfor %}
                    </td>
                    <td>
                        {% for section in contract.section.all %}
                            <strong>{{ section.section_name }}</strong><br>
                            {% for item in section.Item.all %}
                                {{ item.Item_name }}: {{ item.budget }}<br>
                            {% endfor %}
                        {% endfor %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary btn-outline m-1" onclick="openAddUsersModal({{ contract.id }})">✎ Users</button>
                        <button class="btn btn-sm btn-primary btn-outline  m-1" onclick="openAddBudgetModal({{ contract.id }})">✎ Budget</button>
                        <button class="btn btn-sm btn-secondary btn-outline  m-1" onclick="openEditContractModal({{ contract.id }})">✎ Contract</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center">No contracts have been added yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Contract Modal -->
<div id="contractModal" class="modal">
    <div class="modal-box max-w-5xl">
        <h3 class="font-bold text-lg m-4" id="contractModalTitle">Add a New Contract</h3>
        <form id="contract-form" method="post" action="{% url 'edit_project' project.id %}">
            {% csrf_token %}
            <input type="hidden" name="contract_id" id="contract_id">
            <div class="form-control w-full mb-4">
                <input type="text" name="contract_name" placeholder="Contract Name" class="input input-bordered w-full m-2" id="id_contract_name" hx-get="{% url 'check_contract_name' %}" hx-trigger="blur" hx-target="#contract-name-error" hx-swap="innerHTML">
                <div id="contract-name-error" class="text-red-500 text-sm"></div>
            </div>
            <div class="mb-4">
                <button type="button" class="btn btn-sm btn-primary mb-2" onclick="addSection()">+ New Section</button>
            </div>
            <div id="sections-container"></div>
            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Save</button>
                <a href="#" class="btn" onclick="closeContractModal()">Cancel</a>
            </div>
        </form>
        <!-- Section Library -->
        <div id="sectionLibrary" class="mt-8">
            <h3 class="text-lg font-semibold">Library</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for section in section_library %}
                <div class="p-4 border rounded-lg shadow-md draggable" draggable="true" ondragstart="event.dataTransfer.setData('sectionId', '{{ section.id }}');">
                    <h4 class="font-semibold">{{ section.name }}</h4>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<!-- Add/Edit Users Modal -->
<div id="addUsersModal" class="modal">
    <div class="modal-box max-w-5xl">
        <h3 class="font-bold text-lg m-4">Add/Edit Users</h3>
        <form id="add-users-form" method="post" action="{% url 'add_users' %}">
            {% csrf_token %}
            <input type="hidden" name="contract_id" id="add_users_contract_id">
            <div class="overflow-x-auto">
                <table class="table" id="users-table">
                    <thead>
                        <tr>
                            <th>NO.</th>
                            <th>SECTION</th>
                            <th>ITEM</th>
                            <!-- Usernames will be populated here by JavaScript -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sections and items will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Save</button>
                <a href="#" class="btn" onclick="closeAddUsersModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Budget Modal -->
<div id="addBudgetModal" class="modal">
    <div class="modal-box max-w-5xl">
        <h3 class="font-bold text-lg m-4">Add/Edit Budget</h3>
        <form id="add-budget-form" method="post" action="{% url 'add_budget' %}">
            {% csrf_token %}
            <input type="hidden" name="contract_id" id="add_budget_contract_id">
            <div class="overflow-x-auto">
                <table class="table" id="budget-table">
                    <thead>
                        <tr>
                            <th>NO.</th>
                            <th>SECTION</th>
                            <th>ITEM</th>
                            <th>BUDGET</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sections and items will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Save</button>
                <a href="#" class="btn" onclick="closeAddBudgetModal()">Cancel</a>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    function fetchData(url, callback) {
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => callback(data))
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching data: ' + error.message);
            });
    }

    function populateUsersTable(contractId) {
        fetchData(`/ajax/load-contract-data/?contract_id=${contractId}`, data => {
            const usersTable = document.getElementById('users-table');
            const thead = usersTable.querySelector('thead tr');
            const tbody = usersTable.querySelector('tbody');

            thead.innerHTML = '<th>NO.</th><th>SECTION</th><th>ITEM</th>';
            tbody.innerHTML = '';

            data.users.forEach(user => {
                const th = document.createElement('th');
                th.innerHTML = `
                    ${user.username}<br>
                    <input type="checkbox" onclick="toggleUserCheckboxes(${user.id}, this)">
                `;
                thead.appendChild(th);
            });

            data.sections.forEach((section, sectionIndex) => {
                section.items.forEach((item, itemIndex) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${sectionIndex + 1},${itemIndex + 1}</td>
                        <td>${section.section_name}</td>
                        <td>${item.Item_name}</td>
                    `;

                    data.users.forEach(user => {
                        const td = document.createElement('td');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = `user_item_${user.id}_${item.id}`;
                        checkbox.checked = item.users.includes(user.id);
                        checkbox.classList.add(`user-checkbox-${user.id}`);
                        td.appendChild(checkbox);
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });
            });
        });
    }

    function populateBudgetTable(contractId) {
        fetchData(`/ajax/load-contract-data/?contract_id=${contractId}`, data => {
            const budgetTable = document.getElementById('budget-table');
            const thead = budgetTable.querySelector('thead tr');
            const tbody = budgetTable.querySelector('tbody');

            thead.innerHTML = '<th>NO.</th><th>SECTION</th><th>ITEM</th><th>BUDGET</th>';
            tbody.innerHTML = '';

            data.sections.forEach((section, sectionIndex) => {
                section.items.forEach((item, itemIndex) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${sectionIndex + 1},${itemIndex + 1}</td>
                        <td>${section.section_name}</td>
                        <td>${item.Item_name}</td>
                        <td><input type="text" name="budget_${item.id}" value="${item.budget || ''}" class="input input-bordered w-full" /></td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        });
    }

    function toggleUserCheckboxes(userId, masterCheckbox) {
        const checkboxes = document.querySelectorAll(`.user-checkbox-${userId}`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = masterCheckbox.checked;
        });
    }

    window.toggleUserCheckboxes = toggleUserCheckboxes;

    function handleFormSubmission(event, form, url) {
        event.preventDefault();
        const formData = new FormData(form);

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                console.error('Error:', data.error);
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            alert('Error submitting form: ' + error);
        });
    }

    document.getElementById('add-users-form').addEventListener('submit', function(event) {
        handleFormSubmission(event, this, this.action);
    });

    document.getElementById('add-budget-form').addEventListener('submit', function(event) {
        handleFormSubmission(event, this, this.action);
    });

    window.openAddUsersModal = function(contractId) {
        document.getElementById('add_users_contract_id').value = contractId;
        document.getElementById('addUsersModal').classList.add('modal-open');
        populateUsersTable(contractId);
    }

    window.closeAddUsersModal = function() {
        document.getElementById('addUsersModal').classList.remove('modal-open');
    }

    window.openAddBudgetModal = function(contractId) {
        document.getElementById('add_budget_contract_id').value = contractId;
        document.getElementById('addBudgetModal').classList.add('modal-open');
        populateBudgetTable(contractId);
    }

    window.closeAddBudgetModal = function() {
        document.getElementById('addBudgetModal').classList.remove('modal-open');
    }

    window.openContractModal = function() {
        document.getElementById('contractModalTitle').innerText = 'Add a New Contract';
        document.getElementById('contract_id').value = '';
        document.getElementById('id_contract_name').value = '';
        document.getElementById('sections-container').innerHTML = '';
        document.getElementById('contractModal').classList.add('modal-open');
    }

    window.closeContractModal = function() {
        document.getElementById('contractModal').classList.remove('modal-open');
    }

    window.openEditContractModal = function(contractId) {
        document.getElementById('contractModalTitle').innerText = 'Edit Contract';
        document.getElementById('contract_id').value = contractId;
        fetchData(`/ajax/load-contract-data/?contract_id=${contractId}`, data => {
            console.log('Fetched Data:', data); // Debugging line to check the fetched data
            document.getElementById('id_contract_name').value = data.contract_name;
            const sectionsContainer = document.getElementById('sections-container');
            sectionsContainer.innerHTML = '';
            if (data.sections) {
                data.sections.forEach((section, sectionIndex) => {
                    const sectionId = Math.random().toString(36).substr(2, 9);
                    const sectionTemplate = `
                        <div class="section-block form-control w-full m-2 p-4">
                            <div class="flex justify-between items-center">
                                <input type="text" name="section_name" value="${section.section_name}" class="input input-sm input-bordered w-full m-2 section-name" hx-get="{% url 'check_section_name' %}" hx-trigger="blur" hx-target="#section-name-error-${sectionId}" hx-swap="innerHTML">
                                <button type="button" class="btn btn-sm btn-primary m-2" onclick="addItem(this)">+ Item</button>
                                <button type="button" class="btn btn-sm btn-danger m-2" onclick="this.parentNode.parentNode.remove()">x</button>
                            </div>
                            <div id="section-name-error-${sectionId}" class="text-red-500 text-sm mb-2"></div>
                            <div class="items-container">
                                ${section.items ? section.items.map(item => {
                                    const itemId = Math.random().toString(36).substr(2, 9);
                                    const tasksHTML = item.tasks ? item.tasks.map(task => {
                                        const taskId = Math.random().toString(36).substr(2, 9);
                                        const taskTemplate = `
                                            <div class="task-block form-control w-full max-w-xs m-2">
                                                <div class="flex justify-between items-center">
                                                    <input type="text" name="task_name" value="${task.task_name}" class="input input-sm input-bordered w-full m-2 task-name" hx-get="{% url 'check_task_name' %}" hx-trigger="blur" hx-target="#task-name-error-${taskId}" hx-swap="innerHTML">
                                                    <button type="button" class="btn btn-sm btn-danger m-2" onclick="this.parentNode.parentNode.remove()">Delete Task</button>
                                                </div>
                                                <div id="task-name-error-${taskId}" class="text-red-500 text-sm mb-2"></div>
                                            </div>
                                        `;
                                        return taskTemplate;
                                    }).join('') : '';
                                    const itemTemplate = `
                                        <div class="item-block form-control w-full m-2 p-2">
                                            <div class="flex justify-between items-center">
                                                <input type="text" name="item_name" value="${item.Item_name}" class="input input-sm input-bordered w-full m-2 item-name" hx-get="{% url 'check_item_name' %}" hx-trigger="blur" hx-target="#item-name-error-${itemId}" hx-swap="innerHTML">
                                                <button type="button" class="btn btn-sm btn-primary m-2" onclick="addTask(this)">+ Task</button>
                                                <button type="button" class="btn btn-sm btn-danger m-2" onclick="this.parentNode.parentNode.remove()">x</button>
                                            </div>
                                            <div id="item-name-error-${itemId}" class="text-red-500 text-sm m-1"></div>
                                            <div class="tasks-container">
                                                ${tasksHTML}
                                            </div>
                                        </div>
                                    `;
                                    return itemTemplate;
                                }).join('') : ''}
                            </div>
                        </div>
                    `;
                    sectionsContainer.insertAdjacentHTML('beforeend', sectionTemplate);
                });
            }
        });
        document.getElementById('contractModal').classList.add('modal-open');
    }

    window.closeContractModal = function() {
        document.getElementById('contractModal').classList.remove('modal-open');
        // Clear form data
        document.getElementById('contract-form').reset();
        document.getElementById('contractModalTitle').innerText = 'Add a New Contract';
        document.getElementById('contract_id').value = '';
        document.getElementById('sections-container').innerHTML = '';
    }

    window.addSection = function() {
        const sectionId = Math.random().toString(36).substr(2, 9);
        const sectionTemplate = `
            <div class="section-block form-control w-full m-2 p-4">
                <div class="flex justify-between items-center">
                    <input type="text" name="section_name" placeholder="Section Name" class="input input-sm input-bordered w-full m-2 section-name" hx-get="{% url 'check_section_name' %}" hx-trigger="blur" hx-target="#section-name-error-${sectionId}" hx-swap="innerHTML">
                    <button type="button" class="btn btn-sm btn-primary m-2" onclick="addItem(this)">+ Item</button>
                    <button type="button" class="btn btn-sm btn-danger m-2" onclick="this.parentNode.parentNode.remove()">x</button>
                </div>
                <div id="section-name-error-${sectionId}" class="text-red-500 text-sm mb-2"></div>
                <div class="items-container"></div>
            </div>`;
        document.querySelector('#sections-container').insertAdjacentHTML('beforeend', sectionTemplate);
    }

    window.addItem = function(button) {
        const sectionIndex = [...document.querySelectorAll('.section-block')].indexOf(button.closest('.section-block'));
        const itemId = Math.random().toString(36).substr(2, 9);
        const itemTemplate = `
            <div class="item-block form-control w-full m-2 p-2">
                <div class="flex justify-between items-center">
                    <input type="text" name="section[${sectionIndex}][item][${itemId}][item_name]" placeholder="Item Name" class="input input-sm input-bordered w-full m-2 item-name">
                    <button type="button" class="btn btn-sm btn-primary m-2" onclick="addTask(this, ${sectionIndex}, '${itemId}')">+ Task</button>
                    <button type="button" class="btn btn-sm btn-danger m-2" onclick="this.parentNode.parentNode.remove()">x</button>
                </div>
                <div class="tasks-container"></div>
            </div>`;
        button.closest('.section-block').querySelector('.items-container').insertAdjacentHTML('beforeend', itemTemplate);
    }

    window.addTask = function(button, sectionIndex, itemId) {
        const taskId = Math.random().toString(36).substr(2, 9);
        const taskTemplate = `
            <div class="task-block form-control w-full max-w-xs m-2">
                <div class="flex justify-between items-center">
                    <input type="text" name="section[${sectionIndex}][item][${itemId}][task][${taskId}][task_name]" placeholder="Task Name" class="input input-sm input-bordered w-full m-2 task-name">
                    <button type="button" class="btn btn-sm btn-danger m-2" onclick="this.parentNode.parentNode.remove()">Delete Task</button>
                </div>
            </div>`;
        button.closest('.item-block').querySelector('.tasks-container').insertAdjacentHTML('beforeend', taskTemplate);
    }


    window.addSectionFromLibrary = function(sectionId, sectionName, projectNo) {
        fetchData(`/ajax/get-library-section/${sectionId}/`, data => {
            const sectionTemplate = `
                <div class="section-block form-control w-full m-2 p-4">
                    <div class="flex justify-between items-center">
                        <input type="text" name="section_name" value="${data.section_name}-${projectNo}" class="input input-sm input-bordered w-full m-2 section-name" hx-get="{% url 'check_section_name' %}" hx-trigger="blur" hx-target="#section-name-error" hx-swap="innerHTML">
                        <button type="button" class="btn btn-sm btn-primary m-2" onclick="addItem(this)">+ Item</button>
                        <button type="button" class="btn btn-sm btn-danger m-2" onclick="this.parentNode.parentNode.remove()">x</button>
                    </div>
                    <div id="section-name-error" class="text-red-500 text-sm mb-2"></div>
                    <div class="items-container">
                        ${data.items.map(item => {
                            const itemId = Math.random().toString(36).substr(2, 9);
                            return `
                                <div class="item-block form-control w-full m-2 p-2">
                                    <div class="flex justify-between items-center">
                                        <input type="text" name="item_name" value="${item.item_name}-${projectNo}" class="input input-sm input-bordered w-full m-2 item-name" hx-get="{% url 'check_item_name' %}" hx-trigger="blur" hx-target="#item-name-error" hx-swap="innerHTML">
                                        <button type="button" class="btn btn-sm btn-primary m-2" onclick="addTask(this)">+ Task</button>
                                        <button type="button" class="btn btn-sm btn-danger m-2" onclick="this.parentNode.parentNode.remove()">x</button>
                                    </div>
                                    <div id="item-name-error" class="text-red-500 text-sm m-1"></div>
                                    <div class="tasks-container">
                                        ${item.tasks.map(task => `
                                            <div class="task-block form-control w-full max-w-xs m-2">
                                                <div class="flex justify-between items-center">
                                                    <input type="text" name="task_name" value="${task.task_name}-${projectNo}" class="input input-sm input-bordered w-full m-2 task-name" hx-get="{% url 'check_task_name' %}" hx-trigger="blur" hx-target="#task-name-error" hx-swap="innerHTML">
                                                    <button type="button" class="btn btn-sm btn-danger m-2" onclick="this.parentNode.parentNode.remove()">Delete Task</button>
                                                </div>
                                                <div id="task-name-error" class="text-red-500 text-sm mb-2"></div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            document.getElementById('sections-container').insertAdjacentHTML('beforeend', sectionTemplate);
        });
    }

    document.addEventListener('dragover', function(event) {
        event.preventDefault();
    });

    document.getElementById('sections-container').addEventListener('drop', function(event) {
        event.preventDefault();
        const sectionId = event.dataTransfer.getData('sectionId');
        const projectNo = '{{ project.project_no }}';
        addSectionFromLibrary(sectionId, sectionId, projectNo);
    });
});
</script>
{% endblock %}
