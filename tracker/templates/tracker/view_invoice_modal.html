<div id="viewInvoiceModal" class="modal">
    <div class="modal-box max-w-5xl">
        <h3 class="font-bold text-lg m-4">View Invoice</h3>
        <div class="form-control">
            <label class="label">Project</label>
            <input type="text" id="view_project_name" class="input input-bordered w-full" disabled>
        </div>
        <div class="form-control">
            <label class="label">Contract</label>
            <input type="text" id="view_contract_name" class="input input-bordered w-full" disabled>
        </div>
        <div class="form-control">
            <label class="label">Provided Quantities</label>
            <div id="view_provided_quantities_table"></div>
        </div>
        <div class="overflow-x-auto mt-4">
            <table class="table w-full">
                <tbody>
                    <tr>
                        <td class="text-right font-thin w-1/6">Sum of Items €</td>
                        <td><input type="text" id="view_sum_of_items" class="input input-bordered input-sm w-1/4" readonly></td>
                    </tr>
                    <tr>
                        <td class="text-right font-thin w-1/6">Additional Fee %</td>
                        <td><input type="text" id="view_additional_fee_percentage" class="input input-bordered input-sm w-1/4" readonly></td>
                    </tr>
                    <tr>
                        <td class="text-right font-thin w-1/6">Additional Fee €</td>
                        <td><input type="text" id="view_additional_fee" class="input input-bordered input-sm w-1/4" readonly></td>
                    </tr>
                    <tr>
                        <td class="text-right font-bold w-1/6">Invoice Net €</td>
                        <td><input type="text" id="view_invoice_net" class="input input-bordered input-sm w-1/4" readonly></td>
                    </tr>
                    <tr>
                        <td class="text-right font-thin w-1/6">VAT (19%) €</td>
                        <td><input type="text" id="view_vat" class="input input-bordered input-sm w-1/4" readonly></td>
                    </tr>
                    <tr>
                        <td class="text-right font-bold w-1/6">Gross Invoice €</td>
                        <td><input type="text" id="view_gross_invoice" class="input input-bordered input-sm w-1/4" readonly></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="modal-action">
            <a href="#" class="btn" onclick="closeViewInvoiceModal()">Close</a>
        </div>
    </div>
</div>

<script>
function openViewInvoiceModal() {
    document.getElementById('viewInvoiceModal').classList.add('modal-open');
}

function closeViewInvoiceModal() {
    document.getElementById('viewInvoiceModal').classList.remove('modal-open');
}

function viewInvoice(invoiceId) {
    fetch(`/ajax/view-invoice/${invoiceId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('view_project_name').value = data.project_name || '';
            document.getElementById('view_contract_name').value = data.contract_name || '';
            document.getElementById('view_additional_fee_percentage').value = parseFloat(data.additional_fee_percentage).toFixed(2);

            let html = '<table class="table w-full">';
            html += '<thead><tr><th>Section and Item</th><th>Unit</th><th>Rate/Unit €</th><th>Quantity (Provided)</th><th>Total €</th></tr></thead>';
            html += '<tbody>';
            let currentSection = '';
            let sumOfItems = 0;

            data.provided_quantities.forEach(item => {
                if (currentSection !== item.section_name) {
                    currentSection = item.section_name;
                    html += `<tr><td colspan="5" class="font-bold">${currentSection}</td></tr>`;
                }

                const rate = parseFloat(item.rate).toFixed(2);
                const quantity = parseFloat(item.quantity).toFixed(2);
                const total = (quantity * rate).toFixed(2);
                sumOfItems += parseFloat(total);

                html += `<tr>
                            <td class="pl-8">${item.item_name}</td>
                            <td>${item.unit}</td>
                            <td>${rate}</td>
                            <td>${quantity}</td>
                            <td>${total}</td>
                         </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('view_provided_quantities_table').innerHTML = html;

            // Calculate the totals
            document.getElementById('view_sum_of_items').value = sumOfItems.toFixed(2);

            const additionalFeePercentage = parseFloat(document.getElementById('view_additional_fee_percentage').value) || 0;
            const additionalFee = (sumOfItems * additionalFeePercentage) / 100;
            const invoiceNet = sumOfItems + additionalFee;
            const vat = invoiceNet * 0.19;
            const grossInvoice = invoiceNet + vat;

            document.getElementById('view_additional_fee').value = additionalFee.toFixed(2);
            document.getElementById('view_invoice_net').value = invoiceNet.toFixed(2);
            document.getElementById('view_vat').value = vat.toFixed(2);
            document.getElementById('view_gross_invoice').value = grossInvoice.toFixed(2);

            openViewInvoiceModal();
        })
        .catch(error => {
            console.error('Error fetching invoice:', error);
            alert('Error fetching invoice: ' + error.message);
        });
}
</script>
