<!-- contract_form_modal.html -->
<div id="contractModal" class="modal">
    <div class="modal-box max-w-5xl">

        <button class="btn btn-sm btn-circle btn-ghost absolute top-2 right-2" onclick="closeContractModal()">âœ•</button>
        
        <div class="absolute top-3 right-14">
            <label class="cursor-pointer flex items-center">
                <span class="mr-2 font-extralight text-xs">"HOAI Mode"</span>
                <input type="checkbox" id="hoaiModeSwitch" class="toggle toggle-primary" onchange="toggleHOAIMode()">
            </label>
        </div>

        <h3 class="font-bold text-lg m-4" id="contractModalTitle">Neuen Vertrag hinzufÃ¼gen</h3>
        <!-- Add this button to trigger file upload -->
        <input type="file" id="uploadExcel" accept=".xlsx" style="display:none" onchange="handleFileUpload(event)">
        <button type="button" class="btn btn-xs btn-outline" onclick="document.getElementById('uploadExcel').click()">Aus Excel importieren</button>
        <!-- Duplicate Existing Contract -->
        <button type="button" class="btn btn-xs btn-outline" onclick="openDuplicateContractModal()">Vorhandenen Vertrag duplizieren</button>


        <form id="contract-form" method="post" action="{% url 'edit_project' project.id %}">
            {% csrf_token %}
            <input type="hidden" name="contract_id" id="contract_id">

            
            <!-- Contract Name Input with Success/Error Messages -->
            <div class="join space-x-4">
                <!-- Contract Number Display -->
                <label class="form-control w-full max-w-xs">
                    <div class="label mb-0 "">
                        <span class="label-text">Vertrag Nr.</span>
                    </div>
                    <input type="text" name="contract_no" id="id_contract_no" 
                        class="input input-bordered w-full m-0" value="{{ contract.contract_no }}" >
                </label>
                <label class="form-control w-full max-w-xs">
                    <div class="label mb-0">
                        <span class="label-text">Vertrag Name</span>
                    </div>
                    <input type="text" name="contract_name" placeholder="Vertrag Name" class="input input-bordered w-full m-0" id="id_contract_name">
                    <div class="label mt-0">
                        <span id="contract-name-error" class="label-text-alt"></span>
                    </div>
                </label>



                <!-- Hidden input to store HOAI Data -->
                <input type="hidden" name="hoai_data" id="hoai_data">
                            


            </div>

                <div id="hoaiCalculator_div" class="m-4">
                    {% include 'tracker/hoai_contract_modal.html' %}
                </div>
            <div class="mb-4">
                <button type="button" class="btn btn-sm btn-secondary mb-2" onclick="addSection()">+ Neue Sektion</button>
            </div>
            <div id="sections-container"></div>
            <div class="modal-action">
                <button type="submit" class="btn btn-primary btn-outline">Save</button>
                <a href="#" class="btn" onclick="closeContractModal()">Cancel</a>
            </div>
        </form>
        <!-- Section Library -->
        <div id="sectionLibrary" class="mt-8">
            <h3 class="text-lg font-semibold">Library</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for section in section_library %}
                <div class="p-4 border rounded-lg shadow-md draggable" draggable="true" ondragstart="event.dataTransfer.setData('sectionId', '{{ section.id }}');">
                    <h4 class="font-semibold">{{ section.name }}</h4>
                </div>
                {% empty %}
                <p>No sections available in the library.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Sheet Selection Modal -->
<div id="sheetSelectionModal" class="modal">
    <div class="modal-box max-w-sm">
        <h3 class="font-bold text-lg m-4">Select Sheet</h3>
        <div id="sheetList"></div>
        <div class="modal-action">
            <button type="button" class="btn btn-primary" onclick="selectSheet()">Select</button>
            <a href="#" class="btn" onclick="closeSheetSelectionModal()">Cancel</a>
        </div>
    </div>
</div>

<!-- Duplicate Contract Modal -->
<div id="duplicateContractModal" class="modal">
    <div class="modal-box max-w-5xl">
        <h3 class="font-bold text-lg m-4">WÃ¤hlen Sie einen zu duplizierenden Vertrag</h3>
        <div class="accordion" id="projectAccordion">
            {% for project in all_projects %}
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ project.id }}" aria-expanded="false">
                        {{ project.project_name }}
                    </button>
                </h2>
                <div id="collapse-{{ project.id }}" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <ul>
                            {% for contract in project.contract.all %}
                            <li>
                                <button class="btn btn-sm btn-outline m-2 font-extralight" onclick="duplicateContract('{{ contract.id }}')">{{ contract.contract_name }}</button>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="modal-action">
            <a href="#" class="btn" onclick="closeDuplicateContractModal()">Cancel</a>
        </div>
    </div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {

    function fetchData(url, callback) {
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => callback(data))
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching data: ' + error.message);
            });
    }

    // --- HOAI name detection + grouping helpers ---
    function isHoaiSectionName(name = "") {
    const normalized = (name || "").trim().toLowerCase().replace(/\s+/g, " ");
    const m = normalized.match(/^(?:lp\s*|leistungsphase\s*)([1-9])\b/); // LP1..LP9
    if (!m) return null;
    const n = parseInt(m[1], 10);
    return n >= 1 && n <= 9 ? n : null;
    }

    function getOrCreateHoaiGroupLocal() {
    // prefer the one you already defined in the HOAI script
    if (typeof getOrCreateHoaiGroup === "function") return getOrCreateHoaiGroup();
    const root = document.getElementById('sections-container');
    let group = root.querySelector('[data-hoai-group="true"]');
    if (!group) {
        group = document.createElement('div');
        group.setAttribute('data-hoai-group', 'true');
        root.appendChild(group);
    }
    return group;
    }

    function tagHoaiByName(sectionEl, {moveToGroup=true} = {}) {
    const input = sectionEl.querySelector('.section-name');
    if (!input) return;
    const lpNum = isHoaiSectionName(input.value);

    if (lpNum) {
        sectionEl.dataset.hoaiGenerated = 'true';        // data-hoai-generated="true"
        sectionEl.classList.add('hoai-generated');       // optional styling hook
        if (moveToGroup) {
        const group = getOrCreateHoaiGroupLocal();
        if (sectionEl.parentElement !== group) group.appendChild(sectionEl);
        }
    } else {
        delete sectionEl.dataset.hoaiGenerated;
        sectionEl.classList.remove('hoai-generated');
    }
    }

    // Whenever a section name changes, re-infer HOAI and (if needed) move under the HOAI group.
document.addEventListener('input', (e) => {
  if (!e.target.classList?.contains('section-name')) return;
  const section = e.target.closest('.section-block');
  if (!section) return;
  const wasHoai = section.dataset.hoaiGenerated === 'true';
  tagHoaiByName(section, {moveToGroup: true});
  // if it changed from HOAI â†’ non-HOAI, we leave it where it is (you can also move it back if you prefer)
});

    // Function to build the contract JSON
    function buildContractJSON() {
        let contract = {
            contract_name: document.getElementById('id_contract_name').value,
            contract_no: document.getElementById('id_contract_no').value, // Include contract_no
            sections: []
        };

        document.querySelectorAll('.section-block').forEach((sectionBlock, sectionIndex) => {
            const sectionNameInput = sectionBlock.querySelector('.section-name');
            const sectionBillableInput = sectionBlock.querySelector('.section-billable');

            if (!sectionNameInput || !sectionBillableInput) {
                console.warn("Skipping a section block because inputs are missing.");
                return; // Skip this section if inputs are missing
            }

            let section = {
                id: sectionBlock.getAttribute('data-section-id') || null,// Include section ID
                order: sectionIndex, // Add order for the section
                section_name: sectionNameInput.value,
                section_billed_hourly: sectionBillableInput.checked,
                items: []
            };

            sectionBlock.querySelectorAll('.item-block').forEach((itemBlock, itemIndex) => {
                const itemNameInput = itemBlock.querySelector('.item-name');
                const itemDescriptionInput = itemBlock.querySelector('.item-description');

                if (!itemNameInput || !itemDescriptionInput) {
                    console.warn("Skipping an item block because inputs are missing.");
                    return; // Skip this item if inputs are missing
                }

                let item = {
                    order: itemIndex, // Add order for the item
                    id: itemBlock.getAttribute('data-item-id') || null,  // Include item id if it exists
                    Item_name: itemNameInput.value,
                    description: itemDescriptionInput.value,
                    tasks: []
                };

                itemBlock.querySelectorAll('.task-block').forEach(taskBlock => {
                    const taskNameInput = taskBlock.querySelector('.task-name');
                    if (!taskNameInput) {
                        console.warn("Skipping a task block because the input is missing.");
                        return; // Skip this task if the input is missing
                    }

                    let task = {
                        task_name: taskNameInput.value
                    };
                    item.tasks.push(task);
                });

                section.items.push(item);
            });

            contract.sections.push(section);
        });

        return contract;
    }



    // Function to validate the contract form
    function validateContractForm() {
        let isValid = true;
        const contractName = document.getElementById('id_contract_name').value.trim();
        if (!contractName) {
            alert("Contract name cannot be empty.");
            isValid = false;
        }

        document.querySelectorAll('.section-block').forEach(sectionBlock => {
            const sectionName = sectionBlock.querySelector('.section-name').value.trim();
            if (!sectionName) {
                alert("Section name cannot be empty.");
                isValid = false;
            }

            sectionBlock.querySelectorAll('.item-block').forEach(itemBlock => {
                const itemName = itemBlock.querySelector('.item-name').value.trim();
                if (!itemName) {
                    alert("Item name cannot be empty.");
                    isValid = false;
                }

                itemBlock.querySelectorAll('.task-block').forEach(taskBlock => {
                    const taskName = taskBlock.querySelector('.task-name').value.trim();
                    if (!taskName) {
                        alert("Task name cannot be empty.");
                        isValid = false;
                    }
                });
            });
        });

        return isValid;
    }

    // Function to open the contract modal
    window.openContractModal = function(projectId) {
        document.getElementById('contractModalTitle').innerText = 'Neuen Vertrag hinzufÃ¼gen';
        document.getElementById('contract_id').value = '';
        document.getElementById('id_contract_name').value = '';
        document.getElementById('sections-container').innerHTML = ''; // Clear previous sections if any
        document.getElementById('id_contract_no').value = ''; // Clear previous contract_no

        // Fetch the new contract number
        fetch(`/ajax/get-new-contract-number/${projectId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.contract_no) {
                    document.getElementById('id_contract_no').value = data.contract_no; // Populate contract_no
                } else {
                    console.error('Error fetching contract number:', data.error);
                    alert('Failed to fetch contract number. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error fetching contract number:', error);
                alert('Failed to fetch contract number. Please try again.');
            });

        addSection(); // Add default section
        document.getElementById('contractModal').classList.add('modal-open');
    };


    // Function to close the contract modal
    window.closeContractModal = function() {
        document.getElementById('contractModal').classList.remove('modal-open');
        // Clear form data
        document.getElementById('contract-form').reset();
        document.getElementById('contractModalTitle').innerText = 'Neuen Vertrag hinzufÃ¼gen';
        document.getElementById('contract_id').value = '';
        document.getElementById('sections-container').innerHTML = '';

        // Optional: Remove any hidden JSON inputs if they exist
        let jsonInput = document.querySelector('input[name="contract_json"]');
        if (jsonInput) {
            jsonInput.remove();
        }
    }


    // Function to highlight an element temporarily
    function highlightElement(element) {
        // Add Tailwind utility classes for highlighting
        element.classList.add('bg-neutral-200', 'transition', 'duration-100');
        // Remove the highlight after 1 second
        setTimeout(() => {
            element.classList.remove('bg-neutral-200');
        }, 600); // Highlight for 1 second
    }

    // Move Section Up
    window.moveSectionUp = function (button) {
        const section = button.closest('.section-block');
        const previousSection = section.previousElementSibling;

        if (previousSection) {
            section.parentNode.insertBefore(section, previousSection);
            highlightElement(section); // Highlight the moved section
            updateContractJSON(); // Update JSON after rearranging
        }
    };

    // Move Section Down
    window.moveSectionDown = function (button) {
        const section = button.closest('.section-block');
        const nextSection = section.nextElementSibling;

        if (nextSection) {
            section.parentNode.insertBefore(nextSection, section);
            highlightElement(section); // Highlight the moved section
            updateContractJSON(); // Update JSON after rearranging
        }
    };

    // Move Item Up
    window.moveItemUp = function (button) {
        const item = button.closest('.item-block');
        const previousItem = item.previousElementSibling;

        if (previousItem) {
            item.parentNode.insertBefore(item, previousItem);
            highlightElement(item); // Highlight the moved item
            updateContractJSON(); // Update the contract JSON if necessary
        }
    };

    // Move Item Down
    window.moveItemDown = function (button) {
        const item = button.closest('.item-block');
        const nextItem = item.nextElementSibling;

        if (nextItem) {
            item.parentNode.insertBefore(nextItem, item);
            highlightElement(item); // Highlight the moved item
            updateContractJSON(); // Update the contract JSON if necessary
        }
    };


    // Function to update contract JSON after rearranging
    window.updateContractJSON = function() {
        let contractJSON = buildContractJSON();
        console.log("Updated Contract JSON:", contractJSON);

        // Update or create the hidden input field for contract_json
        let jsonInput = document.querySelector('input[name="contract_json"]');
        if (!jsonInput) {
            jsonInput = document.createElement('input');
            jsonInput.type = 'hidden';
            jsonInput.name = 'contract_json';
            document.getElementById('contract-form').appendChild(jsonInput);
        }
        jsonInput.value = JSON.stringify(contractJSON);
    };


    window.openEditContractModal = function (contractId) {
        document.getElementById('contractModalTitle').innerText = 'Edit Contract';
        document.getElementById('contract_id').value = contractId;

        fetchData(`/ajax/load-contract-data/?contract_id=${contractId}`, (data) => {
            console.log('Fetched Data:', data);

            // Determine if any section or item is not editable
            let isContractEditable = true;
            

            data.sections.forEach((section) => {
                const isSectionEditable = section.items.every(
                    (item) => item.quantity === item.available_quantity
                );
                if (!isSectionEditable) {
                    isContractEditable = false;
                }
            });

            // Ensure sections have an 'order' property
            if (data.sections) {
                data.sections.forEach((section, sectionIndex) => {
                    if (section.order === undefined) {
                        section.order = sectionIndex; // Assign order dynamically
                    }
                    if (section.items) {
                        section.items.forEach((item, itemIndex) => {
                            if (item.order === undefined) {
                                item.order = itemIndex; // Assign order dynamically for items
                            }
                        });
                    }
                });
            }

            console.log('Updated Data with Order:', data);

            // Populate contract name and contract number
            const contractNameInput = document.getElementById('id_contract_name');
            const contractNoInput = document.getElementById('id_contract_no');
            contractNameInput.value = data.contract_name;
            contractNoInput.value = data.contract_no; // Populate contract number

            contractNameInput.readOnly = !isContractEditable; 

            // âœ… HOAI Mode Handling
            if (data.hoai_data && Object.keys(data.hoai_data).length > 0) {
                console.log("ðŸŸ¢ HOAI Data Found, Enabling HOAI Mode...");

                // Enable HOAI Mode Switch
                document.getElementById("hoaiModeSwitch").checked = true;
                document.getElementById("hoaiCalculator").classList.remove("hidden");

                // âœ… Set Service Profile first
                let serviceProfileDropdown = document.getElementById("serviceProfile");
                serviceProfileDropdown.value = data.hoai_data.serviceProfile;
                console.log(`ðŸŸ¡ Setting Service Profile: ${data.hoai_data.serviceProfile}`);

                // âœ… Manually trigger change event to update Honorarzone & LPs
                serviceProfileDropdown.dispatchEvent(new Event("change"));

                // âœ… Wait for Honorarzone and LP options to populate before setting other fields
                setTimeout(() => {
                    Object.keys(data.hoai_data).forEach(key => {
                        let inputField = document.getElementById(key);
                        if (inputField) {
                            console.log(`ðŸŸ¡ Setting HOAI Field: ${key} = ${data.hoai_data[key]}`);
                            inputField.value = data.hoai_data[key];
                        }
                    });

                    // âœ… Restore LP selections
                    if (data.hoai_data.lp_enabled) {
                        Object.keys(data.hoai_data.lp_enabled).forEach(lpKey => {
                            let lpCheckbox = document.getElementById(lpKey);
                            if (lpCheckbox) {
                                lpCheckbox.checked = data.hoai_data.lp_enabled[lpKey];
                                console.log(`ðŸŸ¢ Restored LP Checkbox: ${lpKey} = ${lpCheckbox.checked}`);
                            }
                        });
                    }

                    // âœ… Restore LP values
                    if (data.hoai_data.lp_values) {
                        Object.keys(data.hoai_data.lp_values).forEach(lpKey => {
                            let lpInput = document.getElementById(lpKey + "_percentage");
                            if (lpInput) {
                                lpInput.value = data.hoai_data.lp_values[lpKey];
                                console.log(`ðŸŸ¢ Restored LP Value: ${lpKey} = ${lpInput.value}%`);
                            }
                        });
                    }

                    // âœ… Store HOAI Data in Hidden Field
                    document.getElementById("hoai_data").value = JSON.stringify(data.hoai_data);

                }, 500); // â³ Small delay for Honorarzone update

            } else {
                console.log("âš ï¸ No HOAI Data Found, keeping it disabled.");
                document.getElementById("hoaiModeSwitch").checked = false;
                document.getElementById("hoaiCalculator").classList.add("hidden");
            }


            
            // Clear existing sections and populate the container
            const sectionsContainer = document.getElementById('sections-container');
            sectionsContainer.innerHTML = '';

            if (data.sections) {
                // Sort sections based on the 'order' field
                data.sections
                    .sort((a, b) => (a.order ?? 0) - (b.order ?? 0))
                    .forEach((section) => {
                        const sectionId = section.id || `new-${Math.random().toString(36).substr(2, 9)}`;
                        const isSectionEditable = section.items.every(
                            (item) => item.quantity === item.available_quantity
                        );

                        const sectionTemplate = `
                            <div class="section-block form-control w-full m-1 p-2" data-section-id="${sectionId}">
                                <div class="flex items-center space-x-2">
                                    <div class="form-control flex items-center max-w-xs m-0">
                                        <label class="cursor-pointer label m-0 p-0">
                                            <span class="label-text m-1 mb-2 font-extralight ">â§—</span>
                                            <input type="checkbox" name="sections[${sectionId}][billable]" class="checkbox checkbox-accent checkbox-sm section-billable" ${section.section_billed_hourly ? 'checked' : ''} ${isSectionEditable ? '' : ''}>
                                        </label>
                                    </div>
                                    <div class="w-full">
                                        <input type="text" name="section_name" value="${section.section_name}" 
                                            class="input input-sm input-bordered w-full m-2 section-name ${isSectionEditable ? '' : 'input-error'}" 
                                            ${isSectionEditable ? '' : 'readonly'}
                                            >
                                    </div>
                                    <div class="flex space-x-2">
                                        <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionUp(this)">
                                            <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" />
                                                <line x1="12" y1="5" x2="12" y2="19" />
                                                <line x1="18" y1="11" x2="12" y2="5" />
                                                <line x1="6" y1="11" x2="12" y2="5" />
                                            </svg>
                                        </button>
                                        <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionDown(this)">
                                            <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" />
                                                <line x1="12" y1="5" x2="12" y2="19" />
                                                <line x1="18" y1="13" x2="12" y2="19" />
                                                <line x1="6" y1="13" x2="12" y2="19" />
                                            </svg>                                        
                                        </button>
                                        <button type="button" class="btn btn-sm btn-accent" onclick="addItem(this)" ${isSectionEditable ? '' : 'disabled'}>+ Item</button>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="this.parentNode.parentNode.parentNode.remove(); updateContractJSON();" ${isSectionEditable ? '' : 'disabled'}>x</button>
                                    </div>
                                </div>
                                <div class="items-container">
                                    ${section.items
                                        .sort((a, b) => (a.order ?? 0) - (b.order ?? 0)) // Sort items within each section
                                        .map((item) => {
                                            const itemId = item.id || `new-${Math.random().toString(36).substr(2, 9)}`;
                                            const isItemEditable = item.quantity === item.available_quantity;

                                            const tasksHTML = item.tasks
                                                .map((task) => {
                                                    const taskId = Math.random().toString(36).substr(2, 9);
                                                    return `
                                                        <div class="task-block form-control w-full max-w-xs m-1">
                                                            <div class="flex justify-between items-center">
                                                                <input type="text" name="task_name" value="${task.task_name}" class="input input-sm input-bordered w-full m-2 task-name" ${isItemEditable ? '' : 'readonly'}>
                                                                <button 
                                                                    type="button" 
                                                                    class="btn btn-sm btn-danger" 
                                                                    onclick="this.parentNode.parentNode.remove(); updateContractJSON();" 
                                                                    ${isItemEditable ? '' : 'disabled'}>
                                                                    x
                                                                </button>
                                                            </div>
                                                        </div>
                                                    `;
                                                })
                                                .join('');

                                            const itemTemplate = `
                                                <div class="item-block form-control w-full m-2 p-2" data-item-id="${itemId}">
                                                    <div class="flex justify-between items-center">
                                                        <input type="text" name="Item_name" value="${item.Item_name}" 
                                                            class="input input-sm input-bordered w-full m-2 item-name ${isItemEditable ? '' : 'input-error'}" 
                                                            ${isItemEditable ? '' : 'readonly'}>
                                                        <textarea name="description" placeholder="Description" 
                                                            class="textarea textarea-bordered w-full m-2 item-description ${isItemEditable ? '' : 'textarea-ghost'}" 
                                                            ${isItemEditable ? '' : 'readonly'}>${item.description}</textarea>
                                                        <div class="flex space-x-1">
                                                            <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveItemUp(this)">
                                                                <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                    <path stroke="none" d="M0 0h24v24H0z" />
                                                                    <line x1="12" y1="19" x2="12" y2="5" />
                                                                    <line x1="5" y1="12" x2="12" y2="5" />
                                                                    <line x1="19" y1="12" x2="12" y2="5" />
                                                                </svg>
                                                            </button>
                                                            <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveItemDown(this)">
                                                                <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                                    <path stroke="none" d="M0 0h24v24H0z" />
                                                                    <line x1="12" y1="5" x2="12" y2="19" />
                                                                    <line x1="5" y1="12" x2="12" y2="19" />
                                                                    <line x1="19" y1="12" x2="12" y2="19" />
                                                                </svg>
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-accent m-1" onclick="addTask(this)">+ Task</button>
                                                            <button 
                                                                type="button" 
                                                                class="btn btn-sm btn-danger m-1" 
                                                                onclick="this.parentNode.parentNode.remove(); updateContractJSON();" 
                                                                ${isItemEditable ? '' : 'disabled'}>
                                                                x
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="tasks-container">
                                                        ${tasksHTML}
                                                    </div>
                                                </div>
                                            `;
                                            return itemTemplate;
                                        })
                                        .join('')}
                                </div>
                            </div>
                        `;
                        sectionsContainer.insertAdjacentHTML('beforeend', sectionTemplate);
                        const inserted = sectionsContainer.lastElementChild;
tagHoaiByName(inserted, {moveToGroup:true});
                    });
            }
        });

        document.getElementById('contractModal').classList.add('modal-open');
    };

    // Function to handle file upload
    window.handleFileUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheetNames = workbook.SheetNames;

            if (sheetNames.length > 1) {
                openSheetSelectionModal(sheetNames);
            } else {
                handleFileParsing(0);
            }

            window.handleFileParsing = function(sheetIndex) {
                const sheetName = workbook.SheetNames[sheetIndex];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
                const parsedData = parseExcelData(json);
                console.log('Parsed Data:', parsedData); // Debugging line
                populateContractForm(parsedData);
            };
        };
        reader.readAsArrayBuffer(file);
    };

    // Function to open the sheet selection modal and handle sheet selection
    window.openSheetSelectionModal = function(sheetNames) {
        const sheetListContainer = document.getElementById('sheetList');
        sheetListContainer.innerHTML = '';
        sheetNames.forEach((sheetName, index) => {
            const sheetOption = `
                <label class="flex items-center space-x-2">
                    <input type="radio" name="sheetOption" value="${index}" ${index === 0 ? 'checked' : ''} />
                    <span>${sheetName}</span>
                </label>
            `;
            sheetListContainer.insertAdjacentHTML('beforeend', sheetOption);
        });
        document.getElementById('sheetSelectionModal').classList.add('modal-open');

        // Function to handle sheet selection
        window.selectSheet = function() {
            const selectedSheetIndex = document.querySelector('input[name="sheetOption"]:checked').value;
            closeSheetSelectionModal();
            handleFileParsing(selectedSheetIndex);
        };
    };

    // Function to close the sheet selection modal
    function closeSheetSelectionModal() {
        document.getElementById('sheetSelectionModal').classList.remove('modal-open');
    }


    // Function to open the duplicate contract modal
    window.openDuplicateContractModal = function() {
        document.getElementById('duplicateContractModal').classList.add('modal-open');
    };

    // Function to close the duplicate contract modal
    window.closeDuplicateContractModal = function() {
        document.getElementById('duplicateContractModal').classList.remove('modal-open');
    };

    // Function to close the sheet selection modal
    function closeDuplicateContractModal() {
        document.getElementById('duplicateContractModal').classList.remove('modal-open');
    }


    // Function to duplicate contract
    window.duplicateContract = function(contractId) {
        console.log("Starting duplicateContract function with contractId:", contractId);

        fetch(`/ajax/load-contract-data/?contract_id=${contractId}`)
            .then(response => {
                console.log("Response received from server:", response);
                return response.json();
            })
            .then(data => {
                console.log("Parsed contract data structure:", JSON.stringify(data, null, 2));

                if (data && data.contract_name) {
                    // Populate the contract form with all the data
                    populateContractFormWithDuplicatedData(data);
                    // Close the duplicate contract modal
                    closeDuplicateContractModal();
                    console.log("Contract form populated and duplicate contract modal closed.");
                } else {
                    console.error('Failed to duplicate the contract, data missing contract_name.');
                    alert('Failed to duplicate the contract.');
                }
            })
            .catch(error => {
                console.error('Error duplicating contract:', error);
            });
    };

    // Function to close the sheet selection modal
    function closeDuplicateContractModal() {
        document.getElementById('duplicateContractModal').classList.remove('modal-open');
    }




    // Function to parse Excel data into JSON format
    function parseExcelData(data) {
        const contracts = [];
        let currentContract = null;
        let currentSection = null;
        let currentItem = null;

        for (let i = 1; i < data.length; i++) { // Start from 1 to skip header
            const row = data[i];
            const project = row[0];
            const contract = row[1];
            const section = row[2];
            const item = row[3];
            const task = row[4];

            if (contract) {
                if (currentContract) {
                    contracts.push(currentContract);
                }
                currentContract = {
                    contract_name: contract,
                    sections: []
                };
                currentSection = null;
                currentItem = null;
            }

            if (section) {
                if (currentSection) {
                    if (currentItem) {
                        currentSection.items.push(currentItem);
                        currentItem = null;
                    }
                    currentContract.sections.push(currentSection);
                }
                currentSection = {
                    section_name: section,
                    section_billed_hourly: false, // Default value
                    items: []
                };
                currentItem = null;
            }

            if (item) {
                if (currentItem) {
                    currentSection.items.push(currentItem);
                }
                currentItem = {
                    Item_name: item,
                    description: '', // Default value
                    tasks: []
                };
            }

            if (task) {
                if (currentItem) {
                    currentItem.tasks.push({ task_name: task });
                }
            }
        }

        // Add the last contract, section, and item
        if (currentItem) {
            currentSection.items.push(currentItem);
        }
        if (currentSection) {
            currentContract.sections.push(currentSection);
        }
        if (currentContract) {
            contracts.push(currentContract);
        }

        return contracts;
    }

    // Function to populate contract form with parsed data
    function populateContractForm(data) {
        if (data.length === 0) {
            alert("No data to populate");
            return;
        }


        const contract = data[0]; // Assuming only one contract is imported at a time
        console.log('Populating Contract:', contract); // Debugging line

        if (!contract.contract_name) {
            alert("Contract name is missing in the imported data");
            return;
        }

        document.getElementById('id_contract_name').value = contract.contract_name;
        const sectionsContainer = document.getElementById('sections-container');
        sectionsContainer.innerHTML = '';

        contract.sections.forEach(section => {
            const sectionId = Math.random().toString(36).substr(2, 9);
            const sectionTemplate = `
                <div class="section-block form-control w-full m-1 p-2" data-section-id="{{ section.id }}">
                    <div class="flex items-center space-x-2">
                        <div class="form-control flex items-center max-w-xs m-0">
                            <label class="cursor-pointer label m-0 p-0">
                                <span class="label-text mr-1 font-bold">â‚¬</span>
                                <input type="checkbox" name="sections[${sectionId}][billable]" class="checkbox checkbox-accent section-billable" ${section.section_billed_hourly ? 'checked' : ''} />
                            </label>
                        </div>
                        <div class="w-full">
                            <input type="text" name="sections[${sectionId}][section_name]" value="${section.section_name}" class="input input-sm input-bordered w-full m-2 section-name" hx-get="{% url 'check_section_name' %}" hx-trigger="blur" hx-target="#section-name-error-${sectionId}" hx-swap="innerHTML">
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionUp(this)">
                            <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" />
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="18" y1="11" x2="12" y2="5" />
                                <line x1="6" y1="11" x2="12" y2="5" />
                            </svg>
                            </button>
                            <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionDown(this)">
                            <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" />
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="18" y1="13" x2="12" y2="19" />
                                <line x1="6" y1="13" x2="12" y2="19" />
                            </svg>                                        
                            </button>
                            <button type="button" class="btn btn-sm btn-accent" onclick="addItem(this, '${sectionId}')">+ Item</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="this.parentNode.parentNode.parentNode.remove()">x</button>
                        </div>
                    </div>
                    <div id="section-name-error-${sectionId}" class="text-red-500 text-sm mb-2"></div>
                    <div class="items-container">
                        ${section.items.map(item => {
                            const itemId = Math.random().toString(36).substr(2, 9);
                            return `
                                <div class="item-block form-control w-full m-2 p-2"  data-item-id="{{ item.id }}">
                                    <div class="flex justify-between items-center">
                                        <input type="text" name="sections[${sectionId}][items][${itemId}][Item_name]" value="${item.Item_name}" class="input input-sm input-bordered w-full m-2 item-name" hx-get="{% url 'check_Item_name' %}" hx-trigger="blur" hx-target="#item-name-error-${itemId}" hx-swap="innerHTML">
                                        <textarea name="sections[${sectionId}][items][${itemId}][description]" placeholder="Description" class="textarea textarea-bordered w-full m-2 item-description">${item.description}</textarea>
                                        <button type="button" class="btn btn-sm btn-accent m-1" onclick="addTask(this, '${sectionId}', '${itemId}')">+ Task</button>
                                        <button type="button" class="btn btn-sm btn-danger m-1" onclick="this.parentNode.parentNode.remove()">x</button>
                                    </div>
                                    <div id="item-name-error-${itemId}" class="text-red-500 text-sm m-1"></div>
                                    <div class="tasks-container">
                                        ${item.tasks.map(task => {
                                            const taskId = Math.random().toString(36).substr(2, 9);
                                            return `
                                                <div class="task-block form-control w-full max-w-xs m-2">
                                                    <div class="flex justify-between items-center">
                                                        <input type="text" name="sections[${sectionId}][items][${itemId}][tasks][${taskId}][task_name]" value="${task.task_name}" class="input input-sm input-bordered w-full m-2 task-name" hx-get="{% url 'check_task_name' %}" hx-trigger="blur" hx-target="#task-name-error-${taskId}" hx-swap="innerHTML">
                                                        <button type="button" class="btn btn-sm btn-danger m-1" onclick="this.parentNode.parentNode.remove()">x</button>
                                                    </div>
                                                    <div id="task-name-error-${taskId}" class="text-red-500 text-sm mb-2"></div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            sectionsContainer.insertAdjacentHTML('beforeend', sectionTemplate);
            const inserted = sectionsContainer.lastElementChild;
tagHoaiByName(inserted, {moveToGroup:true});

        });
    }


    // New function to populate contract form with duplicated data
    function populateContractFormWithDuplicatedData(data) {
        // Set contract name and other main details
        document.getElementById('id_contract_name').value = data.contract_name + ' (Copy)';
        
        const sectionsContainer = document.getElementById('sections-container');
        sectionsContainer.innerHTML = ''; // Clear any existing sections

        // Iterate through sections and add them to the form
        data.sections.forEach(section => {
            const sectionId = Math.random().toString(36).substr(2, 9);

            let sectionTemplate = `
                <div class="section-block form-control w-full m-1 p-2" data-section-id="${sectionId}">
                    <div class="flex items-center space-x-2">
                        <div class="form-control flex items-center max-w-xs m-0">
                            <label class="cursor-pointer label m-0 p-0">
                                <span class="label-text mr-1 font-bold">â‚¬</span>
                                <input type="checkbox" name="sections[${sectionId}][billable]" class="checkbox checkbox-accent section-billable" ${section.section_billed_hourly ? 'checked' : ''} />
                            </label>
                        </div>
                        <div class="w-full">
                            <input type="text" name="sections[${sectionId}][section_name]" value="${section.section_name}" class="input input-sm input-bordered w-full m-2 section-name">
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" class="btn btn-sm btn-accent" onclick="addItem(this, '${sectionId}')">+ Item</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="this.parentNode.parentNode.parentNode.remove()">x</button>
                        </div>
                    </div>
                    <div class="items-container">`;

            // Add each item under the section
            section.items.forEach(item => {
                const itemId = Math.random().toString(36).substr(2, 9);
                sectionTemplate += `
                    <div class="item-block form-control w-full m-2 p-2" data-item-id="${itemId}">
                        <div class="flex justify-between items-center">
                            <input type="text" name="sections[${sectionId}][items][${itemId}][Item_name]" value="${item.Item_name}" class="input input-sm input-bordered w-full m-2 item-name">
                            <textarea name="sections[${sectionId}][items][${itemId}][description]" class="textarea textarea-bordered w-full m-2 item-description">${item.description}</textarea>
                            <button type="button" class="btn btn-sm btn-danger m-1" onclick="this.parentNode.parentNode.remove()">x</button>
                        </div>
                        <div class="tasks-container"></div>
                    </div>`;
            });

            // Close the section div
            sectionTemplate += `</div></div>`;

            // Add section to the container
            sectionsContainer.insertAdjacentHTML('beforeend', sectionTemplate);
            const inserted = sectionsContainer.lastElementChild;
tagHoaiByName(inserted, {moveToGroup:true});

        });

        console.log("Form populated with contract details.");
    }



    // Function to add hidden input to the form
    function addHiddenInputToForm() {
        let contractJSON = buildContractJSON();
        console.log("Contract JSON:", contractJSON); // Debugging line
        let jsonInput = document.createElement('input');
        jsonInput.type = 'hidden';
        jsonInput.name = 'contract_json';
        jsonInput.value = JSON.stringify(contractJSON);
        document.getElementById('contract-form').appendChild(jsonInput);
    }





    
    window.toggleHOAIMode = function() {
        let hoaiCalculator = document.getElementById("hoaiCalculator");
        hoaiCalculator.classList.toggle("hidden");
    }



    // Function to add a new section
    window.addSection = function() {
        const sectionId = Math.random().toString(36).substr(2, 9);
        const sectionTemplate = `
            <div class="section-block form-control w-full m-1 p-2" data-section-id="{{ section.id }}">
                <div class="flex items-center space-x-2">
                    <div class="form-control flex items-center max-w-xs m-0">
                        <label class="cursor-pointer label m-0 p-0">
                            <span class="label-text mr-1 font-bold">â‚¬</span>
                            <input type="checkbox" name="sections[${sectionId}][billable]" class="checkbox checkbox-accent section-billable" />
                        </label>
                    </div>
                    <div class="w-full">
                        <input type="text" name="sections[${sectionId}][section_name]" placeholder="Sektion Name" class="input input-sm input-bordered w-full m-2 p-2 section-name" hx-get="{% url 'check_section_name' %}" hx-trigger="blur" hx-target="#section-name-error-${sectionId}" hx-swap="innerHTML">
                    </div>
                    <div class="flex space-x-2">
                        <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionUp(this)">
                        <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" />
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="18" y1="11" x2="12" y2="5" />
                            <line x1="6" y1="11" x2="12" y2="5" />
                        </svg>
                        </button>
                        <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionDown(this)">
                        <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" />
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="18" y1="13" x2="12" y2="19" />
                            <line x1="6" y1="13" x2="12" y2="19" />
                        </svg>                                        
                        </button>
                        <button type="button" class="btn btn-sm btn-accent m-1" onclick="addItem(this, '${sectionId}')">+ Item</button>
                        <button type="button" class="btn btn-sm btn-danger m-1" onclick="this.parentNode.parentNode.parentNode.remove()">x</button>
                    </div>
                </div>
                <div id="section-name-error-${sectionId}" class="text-red-500 text-sm mb-2"></div>
                <div class="items-container"></div>
            </div>`;
        document.querySelector('#sections-container').insertAdjacentHTML('beforeend', sectionTemplate);
        const inserted = document.querySelector('#sections-container').lastElementChild;
tagHoaiByName(inserted, {moveToGroup:true});

    }

    // Function to add a new item
    window.addItem = function(button, sectionId) {
    const itemId = `new-${Math.random().toString(36).substr(2, 9)}`; // Prefix for new items
    const itemTemplate = `
            <div class="item-block form-control w-full m-2 p-2" data-item-id="${itemId}">
                <div class="flex justify-between items-center">
                    <input type="text" name="sections[${sectionId}][items][${itemId}][Item_name]" placeholder="Item Name" 
                        class="input input-sm input-bordered w-full m-2 item-name">
                    <textarea name="sections[${sectionId}][items][${itemId}][description]" placeholder="Description" 
                            class="textarea textarea-bordered w-full m-2 item-description"></textarea>
                    <div class="flex space-x-1">
                        <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveItemUp(this)">
                            <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" />
                                <line x1="12" y1="19" x2="12" y2="5" />
                                <line x1="5" y1="12" x2="12" y2="5" />
                                <line x1="19" y1="12" x2="12" y2="5" />
                            </svg>
                        </button>
                        <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveItemDown(this)">
                            <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" />
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="12" y2="19" />
                                <line x1="19" y1="12" x2="12" y2="19" />
                            </svg>
                        </button>
                        
                        <!-- Add Task Button -->
                        <button type="button" class="btn btn-sm btn-accent m-1" onclick="addTask(this)">+ Task</button>

                        <button type="button" class="btn btn-sm btn-danger m-1" onclick="this.parentNode.parentNode.remove()">x</button>
                    </div>
                </div>
                <div class="tasks-container"></div>
            </div>`;
        button.closest('.section-block').querySelector('.items-container').insertAdjacentHTML('beforeend', itemTemplate);
    };


    // Function to add a new task
    window.addTask = function(button, sectionId, itemId) {
        const taskId = Math.random().toString(36).substr(2, 9);
        const taskTemplate = `
            <div class="task-block form-control w-full max-w-xs m-2">
                <div class="flex justify-between items-center">
                    <input type="text" name="sections[${sectionId}][items][${itemId}][tasks][${taskId}][task_name]" placeholder="Task Name" class="input input-sm input-bordered w-full m-2 task-name" hx-get="{% url 'check_task_name' %}" hx-trigger="blur" hx-target="#task-name-error-${taskId}" hx-swap="innerHTML">
                    <button type="button" class="btn btn-sm btn-danger m-1" onclick="this.parentNode.parentNode.remove()">x</button>
                </div>
                <div id="task-name-error-${taskId}" class="text-red-500 text-sm mb-2"></div>
            </div>`;
        button.closest('.item-block').querySelector('.tasks-container').insertAdjacentHTML('beforeend', taskTemplate);
    }

    // Function to add a section from the library
window.addSectionFromLibrary = function(sectionId, options = {}) {
  const target = options.target || document.getElementById('sections-container');
  const newSectionId = `new-${Math.random().toString(36).slice(2)}`;
  const isHoaiGenerated = options.hoaiGenerated === true;

  return new Promise((resolve, reject) => {
    fetchData(`/ajax/get-library-section/${sectionId}/`, data => {
      const sectionTemplate = `
        <div class="section-block form-control w-full m-2 p-4" data-section-id="${newSectionId}">
          <div class="flex justify-between items-center">
            <div class="form-control flex items-center max-w-xs m-0">
              <label class="cursor-pointer label m-0 p-0">
                <span class="label-text mr-1 font-bold">â‚¬</span>
                <input type="checkbox" name="sections[${newSectionId}][billable]" class="checkbox checkbox-accent section-billable" ${data.section_billed_hourly ? 'checked' : ''} />
              </label>
            </div>
            <div class="w-full">
              <input type="text" name="sections[${newSectionId}][section_name]" value="${data.section_name}" class="input input-sm input-bordered w-full m-2 section-name">
            </div>
            <div class="flex space-x-2">
              <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionUp(this)">
                <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" />
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="18" y1="11" x2="12" y2="5" />
                  <line x1="6" y1="11" x2="12" y2="5" />
                </svg>
              </button>
              <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveSectionDown(this)">
                <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" />
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="18" y1="13" x2="12" y2="19" />
                  <line x1="6" y1="13" x2="12" y2="19" />
                </svg>
              </button>
              <button type="button" class="btn btn-sm btn-accent" onclick="addItem(this, '${newSectionId}')">+ Item</button>
              <button type="button" class="btn btn-sm btn-danger" onclick="this.parentNode.parentNode.parentNode.remove()">x</button>
            </div>
          </div>
          <div id="section-name-error-${newSectionId}" class="text-red-500 text-sm mb-2"></div>
          <div class="items-container">
            ${data.items.map(item => {
              const itemId = item.id || `new-${Math.random().toString(36).slice(2)}`;
              return `
                <div class="item-block form-control w-full m-2 p-2" data-item-id="${itemId}">
                  <div class="flex justify-between items-center">
                    <input type="text" name="sections[${newSectionId}][items][${itemId}][Item_name]" value="${item.Item_name}" class="input input-sm input-bordered w-full m-2 item-name">
                    <textarea name="sections[${newSectionId}][items][${itemId}][description]" class="textarea textarea-bordered w-full m-2 item-description">${item.description}</textarea>
                    <div class="flex space-x-1">
                      <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveItemUp(this)">
                        <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" />
                          <line x1="12" y1="19" x2="12" y2="5" />
                          <line x1="5" y1="12" x2="12" y2="5" />
                          <line x1="19" y1="12" x2="12" y2="5" />
                        </svg>
                      </button>
                      <button type="button" class="btn btn-circle btn-sm btn-outline" onclick="moveItemDown(this)">
                        <svg class="h-3 w-3 text-zinc-500" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" />
                          <line x1="12" y1="5" x2="12" y2="19" />
                          <line x1="5" y1="12" x2="12" y2="19" />
                          <line x1="19" y1="12" x2="12" y2="19" />
                        </svg>
                      </button>
                      <button type="button" class="btn btn-sm btn-danger m-1" onclick="this.parentNode.parentNode.parentNode.remove(); updateContractJSON();">x</button>
                    </div>
                  </div>
                  <div class="tasks-container">
                    ${item.tasks.map(task => {
                      const taskId = Math.random().toString(36).slice(2);
                      return `
                        <div class="task-block form-control w-full max-w-xs m-2">
                          <div class="flex justify-between items-center">
                            <input type="text" name="sections[${newSectionId}][items][${itemId}][tasks][${taskId}][task_name]" value="${task.task_name}" class="input input-sm input-bordered w-full m-2 task-name">
                            <button type="button" class="btn btn-sm btn-danger m-1" onclick="this.parentNode.parentNode.parentNode.remove(); updateContractJSON();">x</button>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
      target.insertAdjacentHTML('beforeend', sectionTemplate);

      // Ensure the real node exists, then tag it if needed
      const added = target.querySelector(`.section-block[data-section-id="${newSectionId}"]`);
if (added) {
  // 1) keep your explicit flag if provided
  if (isHoaiGenerated) {
    added.dataset.hoaiGenerated = 'true';
    added.classList.add('hoai-generated');
    // ensure it sits inside the HOAI group
    const group = getOrCreateHoaiGroupLocal();
    if (added.parentElement !== group) group.appendChild(added);
  }

  // 2) ALSO infer by name (covers reloads / edits / library items without the flag)
  tagHoaiByName(added, {moveToGroup:true});

  resolve(added);
} else {
  reject(new Error('Failed to insert section node'));
}

    });
  });
};


    // Event listener for form submission
    document.getElementById('contract-form').addEventListener('submit', function(event) {
        if (!validateContractForm()) {
            event.preventDefault();
            return false;
        }
        addHiddenInputToForm();
    });

    document.getElementById("contract-form").addEventListener("submit", function(event) {
    let hoaiModeEnabled = document.getElementById("hoaiModeSwitch").checked;
    let hoaiData = {};

    if (hoaiModeEnabled) {
        // âœ… Extract Basic HOAI Data
        let serviceProfileDropdown = document.getElementById("serviceProfile");
        let selectedOption = serviceProfileDropdown.options[serviceProfileDropdown.selectedIndex];

        hoaiData = {
            is_hoai_contract: true,  // âœ… Mark as a HOAI contract
            serviceProfile: selectedOption.value,
            service_profile_name: selectedOption.textContent, // âœ… Get profile name
            honorarzone: document.getElementById("honorarzone").value,
            honorarsatz: document.getElementById("honorarsatz").value,
            honorarsatz_factor: document.getElementById("honorarsatzFactor").value,
            baukonstruktionen: document.getElementById("baukonstruktionen").value,
            technischeAnlagen: document.getElementById("technischeAnlagen").value,
            anrechenbareKosten: document.getElementById("anrechenbareKosten").value,
            nebenKosten: document.getElementById("nebenKosten").value,
            zuschlag: document.getElementById("zuschlag").value,
            zuschlag_amount: document.getElementById("zuschlagAmount").textContent,
            vat: document.getElementById("vt").value,
            grundhonorar: document.getElementById("grundhonorar").textContent,
            lp_enabled: {},
            lp_values: {},
            interpolation: {}
        };

        // âœ… Calculate Honorarsatz Factor
        switch (hoaiData.honorarsatz) {
            case "Basishonorarsatz":
                hoaiData.honorarsatz_factor = 0;
                break;
            case "Viertelsatz":
                hoaiData.honorarsatz_factor = 25;
                break;
            case "Mittelsatz":
                hoaiData.honorarsatz_factor = 50;
                break;
            case "Dreiviertelsatz":
                hoaiData.honorarsatz_factor = 75;
                break;
            case "Oberer Honorarsatz":
                hoaiData.honorarsatz_factor = 100;
                break;
            default:
                hoaiData.honorarsatz_factor = 0;
        }

        // âœ… Capture LP selection (checkboxes)
        document.querySelectorAll("#lpContainer input[type='checkbox']").forEach(lpCheckbox => {
            let lpKey = lpCheckbox.id; // e.g., "lp1", "lp2"
            hoaiData.lp_enabled[lpKey] = lpCheckbox.checked;
        });

        // âœ… Capture LP percentage values (inputs)
        document.querySelectorAll("#lpContainer input[type='number']").forEach(lpInput => {
            let lpKey = lpInput.id.replace("_percentage", ""); // Extract LP key (e.g., "lp1")
            hoaiData.lp_values[lpKey] = parseFloat(lpInput.value) || 0;
        });

        // âœ… Get Interpolated Values
        hoaiData.interpolated_basishonorarsatz = document.getElementById("interpolatedBase").textContent;
        hoaiData.interpolated_oberer_honorarsatz = document.getElementById("interpolatedUpper").textContent;

        // âœ… Extract LP Breakdown from Selected Service Profile
        hoaiData.lp_breakdown_actual = JSON.parse(selectedOption.dataset.lpBreakdown || "{}");

        // âœ… Store Interpolation Data
        hoaiData.interpolation = {
            lower_bound_cost: document.getElementById("lower_bound_cost") ? document.getElementById("lower_bound_cost").textContent : "0",
            upper_bound_cost: document.getElementById("upper_bound_cost") ? document.getElementById("upper_bound_cost").textContent : "0",
            lower_bound_von: document.getElementById("lower_bound_von") ? document.getElementById("lower_bound_von").textContent : "0",
            upper_bound_von: document.getElementById("upper_bound_von") ? document.getElementById("upper_bound_von").textContent : "0",
            lower_bound_bis: document.getElementById("lower_bound_bis") ? document.getElementById("lower_bound_bis").textContent : "0",
            upper_bound_bis: document.getElementById("upper_bound_bis") ? document.getElementById("upper_bound_bis").textContent : "0"
        };

        // âœ… Save HOAI data to the hidden input
        document.getElementById("hoai_data").value = JSON.stringify(hoaiData);

        console.log("âœ… HOAI data saved:", hoaiData);
    }
});


    // Drag and drop event listeners
    document.addEventListener('dragover', function(event) {
        event.preventDefault();
    });

    document.getElementById('sections-container').addEventListener('drop', function(event) {
        event.preventDefault();
        const sectionId = event.dataTransfer.getData('sectionId');
        
        addSectionFromLibrary(sectionId);
    });

});
</script>

<style>
  .hoai-generated { outline: 1px dashed #499da8; border-radius: 6px; }
</style>