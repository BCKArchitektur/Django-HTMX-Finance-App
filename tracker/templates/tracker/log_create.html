{% extends 'tracker/base.html' %}

{% block title %}Create Log{% endblock %}

{% block content %}
<div id="selectbar" class="flex flex-row justify-center items-center ">
    <form id="log-form" method="post" class="form-inline w-full">
        {% csrf_token %}
        <div class="form-group-container flex flex-wrap w-full">
            <!-- Project Name Field -->
            <div class="form-group mx-sm-3 mb-2 w-full sm:w-auto">
                {{ form.log_project_name.errors }}
                <select class="select select-bordered w-full max-w-xs">
                    {{ form.log_project_name }}
                </select>
            </div>
            <!-- Contract, Section, and Role Fields -->
            <div class="form-group mx-sm-3 mb-2 w-full sm:w-auto">
                {{ form.log_contract.errors }}
                <select class="select select-bordered w-full max-w-xs">
                    {{ form.log_contract }}
                </select>
                {{ form.log_section.errors }}
                <select class="select select-bordered w-full max-w-xs mt-2">
                    {{ form.log_section }}
                </select>
                {{ form.log_role.errors }}
                <select class="select select-bordered w-full max-w-xs mt-2">
                    {{ form.log_role }}
                </select>
            </div>
            <!-- Task Buttons -->
            <div class="form-group mx-sm-3 mb-2 w-full sm:w-auto">
                {{ form.log_tasks.errors }}
                <input type="hidden" id="id_log_tasks" name="log_tasks">
                <div id="task-buttons-container" class="task-buttons flex flex-wrap gap-2"></div>
                <input class="input input-bordered w-full max-w-xs mt-2" type="text" id="custom-tasks" placeholder="Add custom tasks">
            </div>
            <!-- Time Field -->
            <div class="form-group mx-sm-3 mb-2 w-full sm:w-auto">
                {{ form.log_time.errors }}
                <input class="input input-bordered w-full max-w-xs" type="text" name="log_time" value="{{ form.log_time.value }}">
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-4">Submit</button>
    </form>
</div>
<div id="log-container" class="mt-4">
    <table class="table table-zebra w-full">
        <thead>
            <tr>
                <th>Timestamps</th>
                <th>Project Name</th>
                <th>Contract</th>
                <th>Section</th>
                <th>Role</th>
                <th>Task</th>
                <th>Time</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr class="log-entry" id="log-{{ log.id }}">
                <td>{{ log.log_timestamps }}</td>
                <td>{{ log.log_project_name }}</td>
                <td>{{ log.log_contract }}</td>
                <td>{{ log.log_section }}</td>
                <td>{{ log.log_role }}</td>
                <td>{{ log.get_log_task }}</td>
                <td>{{ log.log_time }}</td>
                <td>
                    <button class="btn btn-error btn-sm" onclick="deleteLog('{{ log.id }}', '{{ csrf_token }}', '{{ log.log_time }}')">x</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center">No logs have been added yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="progress-container mt-4 text-center">
        <h3 class="text-lg font-medium">Hours Logged Today: <span id="total-hours-today">{{ total_hours_today }}</span> / {{ hours_assigned_today }} hours</h3>
        <progress class="progress progress-primary w-56" value="{{ total_hours_today }}" max="{{ hours_assigned_today }}"></progress>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function () {
        let totalHoursToday = parseFloat("{{ total_hours_today }}");
        const hoursAssignedToday = parseFloat("{{ hours_assigned_today }}");

        // Handle the form submission
        $('#log-form').on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '{% url "log_create" %}',
                data: $(this).serialize(),
                success: function (response) {
                    // Update the log container with the new log entry
                    $('#log-container').html($(response).find('#log-container').html());
                    // Reset the form
                    $('#log-form')[0].reset();
                    // Reset task buttons and custom tasks input
                    $('#task-buttons-container').empty();
                    $('#custom-tasks').val('');
                    // Update the total hours today and progress bar
                    totalHoursToday = parseFloat($(response).find('#total-hours-today').text());
                    updateProgressBar(totalHoursToday);
                },
                error: function (error) {
                    console.error('Error:', error);
                }
            });
        });

        // Event listener for custom tasks input changes
        $('#custom-tasks').on('input', updateSelectedTasks);

        function updateSelectedTasks() {
            let selectedTasks = [];
            $(".task-btn.selected").each(function() {
                selectedTasks.push($(this).text()); 
            });
            let customTasks = $("#custom-tasks").val().split(',').map(task => task.trim()).filter(task => task.length > 0);
            selectedTasks = selectedTasks.concat(customTasks);
            $("#id_log_tasks").val(selectedTasks.join(',')); 
        }

        // Load task buttons dynamically if needed (similar to your existing script)
        function loadTasks(roleId) {
            $.ajax({
                url: `/ajax/load-tasks/?role_id=${roleId}`,
                method: 'GET',
                success: function(data) {
                    if (data.tasks && data.tasks.length > 0) {
                        const taskContainer = $('#task-buttons-container');
                        taskContainer.empty(); 

                        data.tasks.forEach(function(task) {
                            const button = $('<button>')
                                .addClass('task-btn btn')
                                .text(task.task_name)
                                .attr('data-task-id', task.id)
                                .on('click', function() {
                                    $(this).toggleClass('selected');
                                    updateSelectedTasks();
                                });

                            taskContainer.append(button);
                        });
                    } else {
                        $('#task-buttons-container').html("<p>No tasks available</p>");
                    }
                },
                error: function(error) {
                    console.error("Error loading tasks:", error);
                    $('#task-buttons-container').html("<p>Error loading tasks</p>");
                }
            });
        }

        // Delete log function
        window.deleteLog = function (logId, csrfToken, logTime) {
            if (confirm('Are you sure you want to delete this log?')) {
                fetch(`/delete-log/${logId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    if (response.ok) {
                        // Remove the log entry from the DOM
                        document.getElementById(`log-${logId}`).remove();
                        // Update total hours today and progress bar
                        totalHoursToday -= parseFloat(logTime);
                        updateProgressBar(totalHoursToday);
                    } else {
                        alert('Failed to delete the log.');
                    }
                })
                .catch(error => alert('Error deleting log: ' + error));
            }
        }

        function updateProgressBar(totalHours) {
            const progressPercentage = (totalHours / hoursAssignedToday) * 100;
            $('#progress-bar').css('width', progressPercentage + '%');
            $('#progress-bar').attr('aria-valuenow', totalHours);
            $('#total-hours-today').text(totalHours.toFixed(2));
        }
    });
</script>
{% endblock %}
